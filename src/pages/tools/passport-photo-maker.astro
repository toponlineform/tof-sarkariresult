---
import Layout from '../../layouts/Layout.astro';
import AdSlot from '../../components/AdSlot.astro';

const title = "Passport Photo Maker - Custom Quantity on A4, 4x6, 5x7 Sheets";
const description = "Create Passport Size Photos online. Select Paper Size (A4, 4x6, 5x7) and choose exactly how many copies you need (1 to 36). Free & HD Quality.";
---

<Layout title={title} description={description}>
  
  {/* Load CropperJS Library */}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <div class="max-w-6xl mx-auto px-4 py-8">
      
      {/* HEADER */}
      <div class="text-center mb-8">
          <span class="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">Smart Print Tool</span>
          <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 mt-3 mb-4">
              Infinity <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-600">Passport Photo Maker</span>
          </h1>
          <p class="text-gray-500 text-lg max-w-2xl mx-auto">
              Select Paper Size (A4, 4x6, 5x7) and choose <strong>Exactly How Many Photos</strong> you want to print.
          </p>
      </div>

      {/* üü¢ TOP AD */}
      <div class="mb-8">
        <AdSlot type="horizontal" />
      </div>

      {/* MAIN TOOL AREA */}
      <div class="bg-white border border-gray-200 rounded-2xl shadow-xl overflow-hidden p-6 md:p-10">
          
          {/* STEP 1: UPLOAD */}
          <div id="step1" class="text-center transition-all">
              <div class="border-3 border-dashed border-indigo-200 bg-indigo-50 rounded-2xl p-12 hover:bg-indigo-100 transition cursor-pointer max-w-2xl mx-auto group" onclick="document.getElementById('fileInput').click()">
                  <div class="text-6xl mb-6 group-hover:scale-110 transition">üì∏</div>
                  <h3 class="text-2xl font-bold text-gray-800 mb-2">Select Your Photo</h3>
                  <p class="text-gray-500">Upload a selfie or portrait to get started</p>
                  <input type="file" id="fileInput" accept="image/*" class="hidden" />
              </div>
          </div>

          {/* STEP 2: CROPPER & SETTINGS */}
          <div id="step2" class="hidden">
              <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">Customize Your Sheet</h3>
              
              <div class="flex flex-col lg:flex-row gap-8">
                  {/* Cropping Area */}
                  <div class="flex-1 bg-gray-900 rounded-xl overflow-hidden h-[400px] md:h-[500px] relative shadow-inner">
                      <img id="cropImage" class="max-w-full" />
                  </div>

                  {/* Controls */}
                  <div class="w-full lg:w-[350px] flex flex-col gap-6">
                      
                      {/* 1. Paper Selection */}
                      <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                          <label class="block text-sm font-bold text-gray-700 mb-2">1. Select Paper Size</label>
                          <select id="paperSelect" class="w-full p-3 border rounded-lg bg-white font-medium focus:ring-2 focus:ring-indigo-500 outline-none">
                              <option value="4x6">4 x 6 Inch (Max 8 Photos)</option>
                              <option value="5x7">5 x 7 Inch (Max 15 Photos)</option>
                              <option value="A4">A4 Size (Max 36 Photos)</option>
                          </select>
                      </div>

                      {/* 2. Quantity Selection */}
                      <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                          <label class="block text-sm font-bold text-gray-700 mb-2">2. How many photos?</label>
                          <div class="flex items-center gap-4">
                              <input type="range" id="qtyRange" min="1" max="8" value="8" class="flex-1 h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                              <input type="number" id="qtyInput" min="1" max="8" value="8" class="w-16 p-2 text-center border rounded-lg font-bold text-indigo-700">
                          </div>
                          <p class="text-xs text-gray-500 mt-2">Adjust slider to save paper space.</p>
                      </div>
                      
                      <button id="cropBtn" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex justify-center items-center gap-2">
                          <span>‚öôÔ∏è</span> Generate Sheet
                      </button>

                      <button id="resetBtn" class="text-gray-500 underline text-sm text-center">Upload Different Photo</button>
                  </div>
              </div>
          </div>

          {/* STEP 3: PREVIEW & DOWNLOAD */}
          <div id="step3" class="hidden text-center">
              <h3 class="text-2xl font-bold text-gray-800 mb-2">Ready to Print!</h3>
              <p class="text-gray-500 mb-6">Here are your <span id="finalCountDisplay" class="font-bold text-indigo-600">8</span> photos on <span id="finalPaperDisplay" class="font-bold">4x6</span> sheet.</p>
              
              <div class="flex flex-col items-center gap-8">
                  {/* Canvas Container */}
                  <div class="border-4 border-gray-300 shadow-2xl bg-gray-200 inline-block overflow-auto max-w-full max-h-[600px] rounded">
                      <canvas id="photoCanvas" class="max-w-full h-auto"></canvas>
                  </div>

                  <div class="flex flex-col sm:flex-row gap-4 w-full max-w-md">
                      <button id="downloadBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg text-lg flex justify-center items-center gap-2 transition animate-bounce-slow">
                          ‚¨áÔ∏è Download HD JPG
                      </button>
                      <button onclick="location.reload()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-4 px-6 rounded-xl shadow-sm transition">
                          ‚Üª Start Over
                      </button>
                  </div>
              </div>
          </div>

      </div>

      {/* üü¢ BOTTOM AD */}
      <div class="mt-8 mb-12">
        <AdSlot type="horizontal" />
      </div>

      {/* SEO CONTENT */}
      <div class="prose prose-indigo max-w-none bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
          <h2 class="text-2xl font-bold text-gray-800">Print Custom Quantity Passport Photos</h2>
          <p class="text-gray-600">
             Unlike other tools that force you to fill the entire page, <strong>Infinity Passport Maker</strong> gives you full control. Need only 4 photos on an A4 sheet? No problem.
          </p>
          
          <h3 class="font-bold text-gray-800 mt-4">Available Paper Sizes:</h3>
          <ul class="list-disc pl-5 space-y-2 text-gray-700">
              <li><strong>4x6 Inch:</strong> Perfect for 1 to 8 photos. Cheapest print cost.</li>
              <li><strong>5x7 Inch:</strong> Great for 1 to 15 photos.</li>
              <li><strong>A4 Size:</strong> Best for bulk printing (1 to 36 photos).</li>
          </ul>
      </div>

  </div>

  {/* üß† JAVASCRIPT LOGIC */}
  <script>
      const fileInput = document.getElementById('fileInput');
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const cropImage = document.getElementById('cropImage');
      const cropBtn = document.getElementById('cropBtn');
      const photoCanvas = document.getElementById('photoCanvas');
      const downloadBtn = document.getElementById('downloadBtn');
      
      // Controls
      const paperSelect = document.getElementById('paperSelect');
      const qtyRange = document.getElementById('qtyRange');
      const qtyInput = document.getElementById('qtyInput');
      const resetBtn = document.getElementById('resetBtn');

      let cropper = null;

      // Paper Configs (Width, Height in px @ 300 DPI, Max Photos)
      const PAPERS = {
          '4x6': { w: 1200, h: 1800, max: 8, cols: 2 },
          '5x7': { w: 1500, h: 2100, max: 15, cols: 3 },
          'A4':  { w: 2480, h: 3508, max: 36, cols: 5 } // 5x7 grid approx
      };

      // 1. Handle File Upload
      fileInput.addEventListener('change', (e) => {
          if (e.target.files && e.target.files.length > 0) {
              const file = e.target.files[0];
              const url = URL.createObjectURL(file);
              
              cropImage.src = url;
              step1.classList.add('hidden');
              step2.classList.remove('hidden');

              // Initialize Cropper
              if(cropper) cropper.destroy();
              // @ts-ignore
              cropper = new Cropper(cropImage, {
                  aspectRatio: 3.5 / 4.5,
                  viewMode: 1,
                  autoCropArea: 0.8,
                  dragMode: 'move',
                  guides: true,
                  center: true,
                  background: false,
              });
          }
      });

      // 2. Sync Paper & Quantity Controls
      function updateLimits() {
          const type = paperSelect.value;
          const config = PAPERS[type];
          
          // Update Max Limits
          qtyRange.max = config.max;
          qtyInput.max = config.max;
          
          // Reset to Max if current value is too high
          if(parseInt(qtyInput.value) > config.max) {
              qtyInput.value = config.max;
              qtyRange.value = config.max;
          }
      }
      
      paperSelect.addEventListener('change', updateLimits);
      
      // Sync Range and Input Box
      qtyRange.addEventListener('input', (e) => qtyInput.value = e.target.value);
      qtyInput.addEventListener('input', (e) => {
          let val = parseInt(e.target.value);
          if(val > parseInt(qtyInput.max)) val = parseInt(qtyInput.max);
          if(val < 1) val = 1;
          qtyRange.value = val;
      });

      // 3. Generate Grid
      cropBtn.addEventListener('click', () => {
          if(!cropper) return;

          const type = paperSelect.value;
          const qty = parseInt(qtyInput.value);
          const config = PAPERS[type];

          document.getElementById('finalCountDisplay').innerText = qty;
          document.getElementById('finalPaperDisplay').innerText = type + (type === 'A4' ? '' : ' Inch');

          const croppedCanvas = cropper.getCroppedCanvas({
              width: 413, height: 531, // 3.5x4.5cm @ 300dpi
              imageSmoothingQuality: 'high'
          });

          // Setup Canvas
          photoCanvas.width = config.w;
          photoCanvas.height = config.h;
          const ctx = photoCanvas.getContext('2d');
          
          // Fill White
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, config.w, config.h);

          // Grid Logic
          const pWidth = 413;
          const pHeight = 531;
          const gap = 30; // 30px gap for easy cutting
          
          // Determine Columns
          const cols = config.cols;
          
          // Calculate Margins to Center
          // Total Width of Content = (cols * w) + ((cols-1) * gap)
          // Since we might not fill the last row, centering calculation should be based on MAX cols possible for consistency
          const totalContentW = (cols * pWidth) + ((cols - 1) * gap);
          const startX = (config.w - totalContentW) / 2;
          const startY = 100; // Top margin

          for (let i = 0; i < qty; i++) {
              const colIndex = i % cols;
              const rowIndex = Math.floor(i / cols);

              const x = startX + (colIndex * (pWidth + gap));
              const y = startY + (rowIndex * (pHeight + gap));

              drawPhoto(ctx, croppedCanvas, x, y, pWidth, pHeight);
          }

          step2.classList.add('hidden');
          step3.classList.remove('hidden');
      });

      function drawPhoto(ctx, img, x, y, w, h) {
          ctx.drawImage(img, x, y, w, h);
          ctx.strokeStyle = "#cccccc"; // Cutting Guide
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, w, h);
      }

      // Download
      downloadBtn.addEventListener('click', () => {
          const link = document.createElement('a');
          const size = paperSelect.value;
          link.download = `Passport-Photos-${size}-${Date.now()}.jpg`;
          link.href = photoCanvas.toDataURL('image/jpeg', 0.95);
          link.click();
      });

      // Reset
      resetBtn.addEventListener('click', () => {
          fileInput.click();
      });
  </script>
</Layout>

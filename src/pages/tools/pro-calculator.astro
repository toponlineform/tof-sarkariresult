---
import Layout from '../../layouts/Layout.astro';
import AdSlot from '../../components/AdSlot.astro';

const title = "Smart Voice Calculator - Scientific, GST & Memory Functions";
const description = "Advanced Online Calculator with Voice Input. Speak to calculate. Features Scientific mode, GST buttons, Memory keys (M+, M-) and History.";
---

<Layout title={title} description={description}>
  
  <div class="max-w-6xl mx-auto px-4 py-8">
      
      {/* HEADER */}
      <div class="text-center mb-8">
          <span class="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">AI Powered</span>
          <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 mt-3 mb-4">
              Infinity <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Smart Calculator</span>
          </h1>
          <p class="text-gray-500 text-lg">
              Speak to Calculate. Use Memory Keys. GST Ready.
          </p>
      </div>

      <div class="mb-8">
        <AdSlot type="horizontal" />
      </div>

      {/* UI CONTAINER */}
      <div class="flex flex-col lg:flex-row gap-8 items-start justify-center">
          
          {/* üßÆ CALCULATOR BODY */}
          <div class="w-full max-w-[450px] bg-slate-900 rounded-[2rem] p-6 shadow-2xl border-4 border-slate-800 relative mx-auto lg:mx-0">
              
              {/* Screen */}
              <div class="bg-[#c8d1bb] p-4 rounded-xl mb-4 shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] text-right font-mono border-4 border-slate-700 h-36 flex flex-col justify-end relative overflow-hidden">
                  <div id="memoryIndicator" class="absolute top-2 left-2 text-xs font-bold text-slate-900 hidden">M</div>
                  <div id="historyDisplay" class="text-slate-600 text-sm h-6 overflow-hidden truncate"></div>
                  <input type="text" id="calcDisplay" class="w-full bg-transparent border-none outline-none text-4xl text-slate-900 font-bold text-right tracking-widest" placeholder="0" readonly />
                  
                  {/* Mic Status */}
                  <div id="micStatus" class="absolute bottom-2 left-2 text-xs font-bold text-red-600 animate-pulse hidden">Listening...</div>
              </div>

              {/* Mode Toggles & Voice */}
              <div class="flex justify-between items-center mb-4 px-1">
                  <div class="flex gap-2 bg-slate-800 p-1 rounded-lg">
                      <button onclick="toggleMode('sci')" id="btnSci" class="px-3 py-1 text-[10px] rounded text-cyan-400 font-bold uppercase hover:bg-slate-700 transition">SCI</button>
                      <button onclick="toggleMode('gst')" id="btnGst" class="px-3 py-1 text-[10px] rounded text-gray-400 font-bold uppercase hover:bg-slate-700 transition">GST</button>
                  </div>
                  
                  {/* üéôÔ∏è VOICE BUTTON */}
                  <button id="micBtn" onclick="startVoice()" class="flex items-center gap-1 bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg transition active:scale-95">
                      <span>üéôÔ∏è</span> Speak
                  </button>
              </div>

              {/* MEMORY ROW (New) */}
              <div class="grid grid-cols-5 gap-2 mb-3">
                  <button class="mem-btn" onclick="memoryClear()">MC</button>
                  <button class="mem-btn" onclick="memoryRecall()">MR</button>
                  <button class="mem-btn" onclick="memoryPlus()">M+</button>
                  <button class="mem-btn" onclick="memoryMinus()">M-</button>
                  <button class="mem-btn text-yellow-400" onclick="deleteChar()">‚å´</button>
              </div>

              {/* KEYS GRID */}
              <div class="grid grid-cols-4 gap-3">
                  
                  {/* Row 1: Scientific (Hidden/Shown) */}
                  <div id="sciRow" class="contents">
                      <button class="sci-btn" onclick="insertFunc('sin')">sin</button>
                      <button class="sci-btn" onclick="insertFunc('cos')">cos</button>
                      <button class="sci-btn" onclick="insertFunc('sqrt')">‚àö</button>
                      <button class="sci-btn" onclick="insertFunc('pow')">^</button>
                  </div>

                  {/* Row 1: GST (Hidden/Shown) */}
                  <div id="gstRow" class="contents hidden">
                      <button class="gst-btn" onclick="calcGST(5)">+5%</button>
                      <button class="gst-btn" onclick="calcGST(12)">+12%</button>
                      <button class="gst-btn" onclick="calcGST(18)">+18%</button>
                      <button class="gst-btn-minus" onclick="calcGST(-18)">-18%</button>
                  </div>

                  {/* Standard Keys */}
                  <button class="op-btn text-red-500" onclick="clearScreen()">AC</button>
                  <button class="op-btn" onclick="insertVal('(')">(</button>
                  <button class="op-btn" onclick="insertVal(')')">)</button>
                  <button class="op-btn" onclick="insertVal('/')">√∑</button>

                  <button class="num-btn" onclick="insertVal('7')">7</button>
                  <button class="num-btn" onclick="insertVal('8')">8</button>
                  <button class="num-btn" onclick="insertVal('9')">9</button>
                  <button class="op-btn" onclick="insertVal('*')">√ó</button>

                  <button class="num-btn" onclick="insertVal('4')">4</button>
                  <button class="num-btn" onclick="insertVal('5')">5</button>
                  <button class="num-btn" onclick="insertVal('6')">6</button>
                  <button class="op-btn" onclick="insertVal('-')">-</button>

                  <button class="num-btn" onclick="insertVal('1')">1</button>
                  <button class="num-btn" onclick="insertVal('2')">2</button>
                  <button class="num-btn" onclick="insertVal('3')">3</button>
                  <button class="op-btn" onclick="insertVal('+')">+</button>

                  <button class="num-btn col-span-2" onclick="insertVal('0')">0</button>
                  <button class="num-btn" onclick="insertVal('.')">.</button>
                  <button class="equal-btn" onclick="calculate()">=</button>
              </div>
          </div>

          {/* üìú HISTORY TAPE */}
          <div class="w-full lg:w-[350px] bg-white border border-gray-200 rounded-2xl shadow-lg p-6 h-[550px] flex flex-col">
              <h3 class="font-bold text-gray-800 text-lg border-b pb-2 mb-2 flex justify-between items-center">
                  <span>üìú History</span>
                  <button onclick="clearHistory()" class="text-xs text-red-500 hover:underline">Clear All</button>
              </h3>
              <div id="historyList" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                  <p class="text-center text-gray-400 text-sm mt-10">Start calculating...</p>
              </div>
              
              {/* Voice Guide */}
              <div class="mt-4 bg-indigo-50 p-3 rounded-lg text-xs text-indigo-800 border border-indigo-100">
                  <strong>üéôÔ∏è Try saying:</strong>
                  <ul class="mt-1 space-y-1 list-disc pl-4">
                      <li>"Twenty five plus fifty"</li>
                      <li>"One hundred minus eighteen percent"</li>
                      <li>"Square root of 144"</li>
                  </ul>
              </div>
          </div>

      </div>

      <div class="mt-8 mb-12">
        <AdSlot type="horizontal" />
      </div>

  </div>

  <style>
      .num-btn { @apply bg-slate-700 text-white font-bold text-xl py-3.5 rounded-lg shadow-[0_4px_0_rgb(30,41,59)] active:shadow-none active:translate-y-[4px] transition-all; }
      .op-btn { @apply bg-slate-800 text-cyan-400 font-bold text-xl py-3.5 rounded-lg shadow-[0_4px_0_rgb(15,23,42)] active:shadow-none active:translate-y-[4px] transition-all; }
      .sci-btn { @apply bg-slate-600 text-xs text-white font-bold py-3 rounded-lg shadow-[0_3px_0_rgb(51,65,85)] active:shadow-none active:translate-y-[3px] transition-all; }
      .gst-btn { @apply bg-emerald-700 text-xs text-white font-bold py-3 rounded-lg shadow-[0_3px_0_rgb(4,120,87)] active:shadow-none active:translate-y-[3px] transition-all; }
      .gst-btn-minus { @apply bg-rose-700 text-xs text-white font-bold py-3 rounded-lg shadow-[0_3px_0_rgb(190,18,60)] active:shadow-none active:translate-y-[3px] transition-all; }
      .mem-btn { @apply bg-slate-800 text-[10px] text-gray-400 font-bold py-2 rounded shadow-[0_2px_0_rgb(15,23,42)] active:shadow-none active:translate-y-[2px] transition-all hover:text-white; }
      .equal-btn { @apply bg-indigo-600 text-white font-bold text-2xl py-3.5 rounded-lg shadow-[0_4px_0_rgb(79,70,229)] active:shadow-none active:translate-y-[4px] transition-all; }
      
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  </style>

  {/* üß† JAVASCRIPT LOGIC */}
  <script>
      const display = document.getElementById('calcDisplay');
      const historyDisplay = document.getElementById('historyDisplay');
      const historyList = document.getElementById('historyList');
      const sciRow = document.getElementById('sciRow');
      const gstRow = document.getElementById('gstRow');
      const btnSci = document.getElementById('btnSci');
      const btnGst = document.getElementById('btnGst');
      const micStatus = document.getElementById('micStatus');
      const memoryIndicator = document.getElementById('memoryIndicator');

      let currentExp = "";
      let memoryValue = 0;
      
      // --- MODE SWITCH ---
      // @ts-ignore
      window.toggleMode = (mode) => {
          if(mode === 'sci') {
              sciRow.classList.remove('hidden');
              gstRow.classList.add('hidden');
              btnSci.className = "px-3 py-1 text-[10px] rounded text-cyan-400 font-bold uppercase bg-slate-700 transition";
              btnGst.className = "px-3 py-1 text-[10px] rounded text-gray-500 font-bold uppercase hover:bg-slate-700 transition";
          } else {
              sciRow.classList.add('hidden');
              gstRow.classList.remove('hidden');
              btnGst.className = "px-3 py-1 text-[10px] rounded text-emerald-400 font-bold uppercase bg-slate-700 transition";
              btnSci.className = "px-3 py-1 text-[10px] rounded text-gray-500 font-bold uppercase hover:bg-slate-700 transition";
          }
      };

      // --- CORE CALC FUNCTIONS ---
      // @ts-ignore
      window.insertVal = (val) => {
          if(display.value === "Error") window.clearScreen();
          currentExp += val;
          display.value = currentExp;
      };

      // @ts-ignore
      window.insertFunc = (func) => {
          if(display.value === "Error") window.clearScreen();
          currentExp += func === 'pow' ? '^' : func + '(';
          display.value = currentExp;
      };

      // @ts-ignore
      window.clearScreen = () => {
          currentExp = "";
          display.value = "";
          historyDisplay.innerText = "";
      };

      // @ts-ignore
      window.deleteChar = () => {
          currentExp = currentExp.toString().slice(0, -1);
          display.value = currentExp;
      };

      // @ts-ignore
      window.calculate = (speak = false) => {
          try {
              let evalStr = currentExp;
              evalStr = evalStr.replace(/sin/g, 'Math.sin');
              evalStr = evalStr.replace(/cos/g, 'Math.cos');
              evalStr = evalStr.replace(/sqrt/g, 'Math.sqrt');
              evalStr = evalStr.replace(/\^/g, '**');
              
              // Handle Percent
              if(evalStr.includes('%')) {
                   evalStr = evalStr.replace(/(\d+)%/g, '($1/100)');
              }

              const result = eval(evalStr);
              const finalRes = Number(result.toFixed(4)); // Avoid weird decimals
              
              addToHistory(currentExp, finalRes);
              
              historyDisplay.innerText = currentExp + " =";
              display.value = finalRes;
              currentExp = finalRes.toString();

              if(speak) speakResult(finalRes);

          } catch (e) {
              display.value = "Error";
              currentExp = "";
          }
      };

      // --- GST FUNCTIONS ---
      // @ts-ignore
      window.calcGST = (rate) => {
          try {
              const amount = parseFloat(display.value || "0");
              if(amount === 0) return;

              let finalAmount = 0;
              if(rate > 0) {
                  finalAmount = amount + (amount * rate / 100);
                  historyDisplay.innerText = `${amount} + ${rate}% GST`;
              } else {
                  const r = Math.abs(rate);
                  finalAmount = amount / (1 + (r/100)); // Remove GST
                  historyDisplay.innerText = `${amount} - ${r}% GST`;
              }
              
              const res = Number(finalAmount.toFixed(2));
              display.value = res;
              currentExp = res.toString();
              addToHistory(historyDisplay.innerText, res);
          } catch(e) { display.value = "Error"; }
      };

      // --- MEMORY FUNCTIONS ---
      // @ts-ignore
      window.memoryPlus = () => {
          const val = parseFloat(display.value || "0");
          memoryValue += val;
          toggleMemIndicator();
      };
      // @ts-ignore
      window.memoryMinus = () => {
          const val = parseFloat(display.value || "0");
          memoryValue -= val;
          toggleMemIndicator();
      };
      // @ts-ignore
      window.memoryRecall = () => {
          currentExp += memoryValue.toString();
          display.value = currentExp;
      };
      // @ts-ignore
      window.memoryClear = () => {
          memoryValue = 0;
          toggleMemIndicator();
      };

      function toggleMemIndicator() {
          if(memoryValue !== 0) memoryIndicator.classList.remove('hidden');
          else memoryIndicator.classList.add('hidden');
      }

      // --- HISTORY & VOICE ---
      function addToHistory(exp, res) {
          const item = document.createElement('div');
          item.className = "flex justify-between items-center bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100 border border-gray-100 animate-fade-in";
          item.innerHTML = `<span class="text-xs text-gray-500 font-mono">${exp}</span><span class="font-bold text-gray-800 font-mono">= ${res}</span>`;
          item.onclick = () => { currentExp = res.toString(); display.value = res; };
          if(historyList.children[0]?.tagName === 'P') historyList.innerHTML = '';
          historyList.prepend(item);
      }

      // @ts-ignore
      window.clearHistory = () => {
          historyList.innerHTML = '<p class="text-center text-gray-400 text-sm mt-10">History Cleared</p>';
      };

      function speakResult(text) {
          if ('speechSynthesis' in window) {
              const msg = new SpeechSynthesisUtterance(text);
              window.speechSynthesis.speak(msg);
          }
      }

      // --- VOICE INPUT LOGIC (Web Speech API) ---
      // @ts-ignore
      window.startVoice = () => {
          // @ts-ignore
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
              alert("Voice input is not supported in this browser. Try Chrome.");
              return;
          }

          const recognition = new SpeechRecognition();
          recognition.lang = 'en-US';
          recognition.start();

          micStatus.classList.remove('hidden');

          recognition.onresult = (event) => {
              const transcript = event.results[0][0].transcript.toLowerCase();
              processVoiceCommand(transcript);
              micStatus.classList.add('hidden');
          };

          recognition.onerror = () => {
              micStatus.classList.add('hidden');
              alert("Could not hear you. Please try again.");
          };
      };

      function processVoiceCommand(cmd) {
          // Clean text: "plus" -> "+", "minus" -> "-"
          let eq = cmd.replace(/plus/g, '+')
                      .replace(/minus/g, '-')
                      .replace(/divided by/g, '/')
                      .replace(/times/g, '*')
                      .replace(/multiplied by/g, '*')
                      .replace(/x/g, '*')
                      .replace(/percent/g, '%');
          
          // Remove non-math chars except digits and operators
          eq = eq.replace(/[^0-9+\-*/%.()]/g, '');

          if(eq) {
              currentExp = eq;
              display.value = eq;
              window.calculate(true); // Calculate and Speak result
          }
      }

      // Keyboard
      document.addEventListener('keydown', (e) => {
          const key = e.key;
          if(/[0-9.+\-*/%()]/.test(key)) window.insertVal(key);
          if(key === 'Enter') window.calculate();
          if(key === 'Backspace') window.deleteChar();
          if(key === 'Escape') window.clearScreen();
      });

  </script>
</Layout>

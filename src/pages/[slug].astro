---
// src/pages/[slug].astro
import Layout from '../layouts/Layout.astro';
import AdSlot from '../components/AdSlot.astro';
import { allPosts } from '../data/index.js';

export async function getStaticPaths() {
  return allPosts.map((post) => {
    const relatedPosts = allPosts
      .filter(p => p.category === post.category && p.slug !== post.slug)
      .sort((a, b) => {
          const parseDate = (d) => {
             if(!d) return 0;
             const cleanDate = d.trim().replace(/-/g, '/');
             const p = cleanDate.split('/');
             if(p.length !== 3) return 0;
             return new Date(`${p[2]}-${p[1]}-${p[0]}`).getTime();
          };
          return parseDate(b.updatedDate || b.postDate) - parseDate(a.updatedDate || a.postDate);
      })
      .slice(0, 6);

    return { params: { slug: post.slug }, props: { post, relatedPosts } };
  });
}

const { post, relatedPosts } = Astro.props;

// --- üß† LOGIC ADAPTERS ---
const catLower = post.category ? post.category.toLowerCase() : "";
const isSimpleMode = catLower.includes("syllabus") || catLower.includes("previous") || catLower.includes("paper") || catLower.includes("answer key");

let stepsHeader = "How to Apply";
if (isSimpleMode) stepsHeader = "How to Download";
else if (catLower.includes("admit card")) stepsHeader = "How to Download Admit Card";
else if (catLower.includes("result")) stepsHeader = "How to Check Result";
else if (catLower.includes("admission")) stepsHeader = "How to Apply for Admission";

// 1. Universal Total Calculator
const calculateTotal = (data, key) => {
    if (!data || !key) return null;
    const skipKeys = ['age', 'year', 'code', 's.no', 'serial', 'qualification', 'eligibility', 'post name', 'category', 'subject', 'activity', 'trade', 'pay scale', 'event', 'eye', 'exam'];
    if (skipKeys.some(k => key.toLowerCase().includes(k))) return null;

    let total = 0;
    let hasNumbers = false;
    for (let item of data) {
        let val = item[key];
        if (!val) continue;
        let clean = String(val).replace(/,/g, '').replace(/\(.*\)/, '').replace(/[^\d.]/g, '').trim(); 
        if (clean && !isNaN(clean)) {
            total += parseFloat(clean);
            hasNumbers = true;
        } 
    }
    return hasNumbers ? total : null;
};

// 2. Header Formatter
const formatHeader = (key) => {
    if (key.includes(' ')) return key;
    const upperKeys = ["ur", "obc", "sc", "st", "ews", "pwbd", "esm", "gen", "ph", "cbt", "pet", "pst", "dob", "gk", "ga", "mcq", "it", "ti"];
    if (upperKeys.includes(key.toLowerCase())) return key.toUpperCase();
    return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim();
};

// 3. Data Type Helper
const getDataType = (data) => {
    if (Array.isArray(data) && data.length > 0) {
        if (data[0].title && (data[0].data || data[0].table || data[0].tableData)) return 'complex-block'; 
        if (typeof data[0] === 'object') return 'table';
        return 'list';
    }
    return 'unknown';
};

const getBtnStyle = (title) => {
  const t = title.toLowerCase();
  if (t.includes('apply') || t.includes('login') || t.includes('registration')) return 'bg-blue-600 hover:bg-blue-700 border-blue-700 text-white';
  if (t.includes('download') || t.includes('notification') || t.includes('result') || t.includes('pdf') || t.includes('notice')) return 'bg-red-600 hover:bg-red-700 border-red-700 text-white';
  if (t.includes('official') || t.includes('website')) return 'bg-gray-800 hover:bg-black border-black text-white';
  return 'bg-green-600 hover:bg-green-700 border-green-700 text-white';
};

// --- ‚è≥ DATE PARSING LOGIC (For Counter) ---
const getLastDateISO = () => {
    // Priority 1: Direct 'lastDate' field from post (Cleanest way)
    if (post.lastDate) {
        const parts = post.lastDate.trim().split('/');
        if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    // Priority 2: Fallback to 'importantDates' array search
    if (post.importantDates) {
        const lastDateObj = post.importantDates.find(d => d.label.toLowerCase().includes('last date') || d.label.toLowerCase().includes('closing date'));
        if (lastDateObj) {
            const dateStr = lastDateObj.value.replace(/ \(.*\)/, '').trim(); 
            const parts = dateStr.split(/[/-]/);
            if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    }
    return null;
};
const lastDateISO = getLastDateISO();

const shareUrl = `https://toponlineform.com/${post.slug}`;
const shareTitle = post.title;
const waLink = `whatsapp://send?text=‚úÖ *${encodeURIComponent(shareTitle)}* üëá%0A%0A${encodeURIComponent(shareUrl)}`;
const tgLink = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=‚úÖ *${encodeURIComponent(shareTitle)}* üëá`;

const formatText = (text) => String(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br />');

---

<Layout 
    title={post.title} 
    description={post.shortInfo} 
    isPost={true}
>
  
  <div class="max-w-7xl mx-auto px-1">
      <nav class="flex text-xs text-gray-500 mb-2 font-medium overflow-x-auto whitespace-nowrap">
        <a href="/" class="hover:text-blue-700">Home</a> <span class="mx-1">‚Ä∫</span>
        <a href={`/${post.category.toLowerCase().replace(/\s+/g, '-')}`} class="hover:text-blue-700 text-blue-600">{post.category}</a> <span class="mx-1">‚Ä∫</span>
        <span class="text-gray-600 truncate max-w-[250px]">{post.shortTitle || "Details"}</span>
      </nav>
  </div>

  <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6 mb-10 items-start">

    {/* LEFT COLUMN */}
    <main class="flex-1 min-w-0 w-full">
        <article class="bg-white p-3 md:p-5 border border-gray-400 font-sans shadow-sm">
            
            <header class="text-center mb-6">
            <h1 class="text-xl md:text-2xl lg:text-3xl font-extrabold text-[#d32f2f] mb-3 leading-snug uppercase">
                {post.title}
            </h1>
            
            <div class="flex flex-wrap justify-center gap-4 text-sm text-gray-700 font-bold mb-4">
                <span class="bg-gray-100 px-2 py-1 rounded border border-gray-200 uppercase">üìÖ Posted: {post.postDate}</span>
                {post.updatedDate && <span class="bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200 uppercase">üìù Updated: {post.updatedDate}</span>}
            </div>

            {/* üî• Job Highlights Bar */}
            {(post.totalVacancy || post.salary) && (
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 text-center">
                    {post.totalVacancy && (
                        <div class="bg-gray-50 border border-gray-200 p-2 rounded">
                            <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">Total Vacancy</span>
                            <span class="font-bold text-gray-900">{post.totalVacancy}</span>
                        </div>
                    )}
                    {post.salary && (
                        <div class="bg-gray-50 border border-gray-200 p-2 rounded">
                            <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">Salary</span>
                            <span class="font-bold text-green-700 text-sm">{post.salary}</span>
                        </div>
                    )}
                    {post.state && (
                        <div class="bg-gray-50 border border-gray-200 p-2 rounded">
                            <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">Location</span>
                            <span class="font-bold text-gray-900">{post.state}</span>
                        </div>
                    )}
                    {post.lastDate && (
                        <div class="bg-gray-50 border border-gray-200 p-2 rounded">
                            <span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">Last Date</span>
                            <span class="font-bold text-red-600">{post.lastDate}</span>
                        </div>
                    )}
                </div>
            )}

            {/* üî• NEW: LIVE COUNTDOWN TIMER (The Urgency Feature) */}
            {lastDateISO && !isSimpleMode && (
                <div id="countdown-box" data-date={lastDateISO} class="hidden mb-4 rounded-lg border-l-4 p-3 shadow-sm transition-all duration-300">
                    <div class="flex flex-col md:flex-row items-center justify-center gap-2">
                        <span id="timer-label" class="text-xs font-bold uppercase tracking-widest"></span>
                        <div id="timer-display" class="text-lg md:text-xl font-black font-mono tracking-wide">Calculating...</div>
                    </div>
                </div>
            )}

            {post.shortInfo && (
                <div class="text-left bg-[#fffae6] border border-[#f0c14b] p-3 text-sm md:text-base text-gray-800 leading-relaxed">
                <p><strong class="text-[#d32f2f]">Short Information:</strong> <span set:html={formatText(post.shortInfo)}></span></p>
                </div>
            )}
            </header>

            <AdSlot type="horizontal" />

            {/* TOC */}
            <div class="mb-6 bg-blue-50 border border-blue-200 p-3 rounded-sm">
                <p class="text-[10px] font-bold text-blue-800 uppercase mb-2 tracking-wider">Quick Navigation:</p>
                <div class="flex flex-wrap gap-2 text-xs font-semibold text-blue-700">
                    {!isSimpleMode && post.importantDates && <a href="#dates" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üìÖ Dates & Fees</a>}
                    {!isSimpleMode && (post.vacancyDetails || post.stateWiseVacancy || post.totalVacancy) && <a href="#vacancy" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üì¶ Vacancy</a>}
                    {!isSimpleMode && (post.salary || post.salaryDetails) && <a href="#salary" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üí∞ Salary</a>}
                    {post.selectionProcess && <a href="#selection" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üéØ Selection</a>}
                    {post.examPattern && <a href="#pattern" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üìù Pattern</a>}
                    {post.extraSections && post.extraSections.length > 0 && <a href="#extra-sections" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üìè Standards</a>}
                    {post.syllabus && <a href="#syllabus" class="bg-white px-2 py-1 border border-blue-200 rounded hover:shadow-sm">üìñ Syllabus</a>}
                    {post.faqs && post.faqs.length > 0 && <a href="#faqs" class="bg-white px-2 py-1 border border-yellow-200 text-yellow-700 rounded hover:shadow-sm">‚ùì FAQs</a>}
                    <a href="#links" class="bg-white px-2 py-1 border border-red-200 text-red-600 rounded hover:shadow-sm">üîó Important Links</a>
                </div>
            </div>

            {/* DATES & FEES */}
            {!isSimpleMode && post.importantDates && post.importantDates.length > 0 && (
            <div id="dates" class="grid grid-cols-1 md:grid-cols-2 gap-0 border border-gray-400 mb-6 scroll-mt-20">
            <div class="border-b md:border-b-0 md:border-r border-gray-400">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Important Dates</div>
                <div class="bg-white p-2">
                <ul class="space-y-2 text-sm">
                    {post.importantDates.map((date) => (
                    <li class="flex justify-between border-b border-gray-200 last:border-0 pb-1">
                        <span class="font-bold text-gray-700">{date.label}</span><span class="text-gray-900 font-medium">{date.value}</span>
                    </li>
                    ))}
                </ul>
                </div>
            </div>
            <div>
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Application Fee</div>
                <div class="bg-white p-2">
                {post.applicationFee ? (
                    <ul class="space-y-2 text-sm">
                        {post.applicationFee.map((fee) => (
                        <li class="flex justify-between border-b border-gray-200 last:border-0 pb-1">
                            <span class="font-bold text-gray-700">{fee.category}</span><span class="text-gray-900 font-medium">{fee.amount}</span>
                        </li>
                        ))}
                    </ul>
                ) : (<div class="text-center text-sm py-2">Check Notification</div>)}
                <div class="mt-2 text-[11px] text-gray-500 text-center italic">Payment: Online Mode (Net Banking/Card/UPI)</div>
                </div>
            </div>
            </div>
            )}

            {/* VACANCY & AGE */}
            {!isSimpleMode && (post.ageLimit || post.vacancyDetails) && (
            <div id="vacancy" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Vacancy Details & Age Limit</div>
                {post.ageLimit && (
                    <div class="p-3 text-center border-b border-gray-300 bg-gray-50">
                        <p class="text-sm font-bold text-gray-800 uppercase tracking-wide">Age Limit: <span class="font-normal">{post.ageLimit}</span></p>
                        {post.ageRelaxation && <p class="text-xs text-gray-500 mt-1 italic tracking-wider">({post.ageRelaxation})</p>}
                    </div>
                )}
                {post.vacancyDetails && (
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse text-center">
                            <thead class="bg-gray-100 text-gray-800 text-xs uppercase font-bold">
                                <tr>
                                    {Object.keys(post.vacancyDetails[0]).map(key => (
                                        <th class="border border-gray-300 px-2 py-2 text-left">{formatHeader(key)}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {post.vacancyDetails.map((row, i) => (
                                    <tr class="hover:bg-yellow-50 transition">
                                        {Object.values(row).map((val, idx) => (
                                            <td class={`border border-gray-300 px-2 py-2 text-left ${idx===0 ? 'font-bold text-gray-700' : 'text-gray-600'}`} set:html={formatText(val)}></td>
                                        ))}
                                    </tr>
                                ))}
                                <tr class="bg-gray-200 font-bold">
                                    {Object.keys(post.vacancyDetails[0]).map((key, index) => {
                                        if (index === 0) return <td class="border border-gray-300 px-2 py-2 text-right uppercase">Total Vacancy</td>;
                                        const total = calculateTotal(post.vacancyDetails, key);
                                        return <td class="border border-gray-300 px-2 py-2 text-[#d32f2f]">{total || ""}</td>;
                                    })}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
            )}

            {/* CATEGORY/STATE VACANCY */}
            {!isSimpleMode && post.stateWiseVacancy && post.stateWiseVacancy.length > 0 && (
            <div id="state-vacancy" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">
                    {post.vacancyTableTitle || "Category Wise Vacancy Details"}
                </div>
                <div class="bg-white">
                {getDataType(post.stateWiseVacancy) === 'table' ? (
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse border border-gray-300 text-center">
                            <thead class="bg-gray-100 font-bold text-gray-700 whitespace-nowrap uppercase text-xs">
                                <tr>
                                    {(() => {
                                        const rawKeys = Object.keys(post.stateWiseVacancy[0]);
                                        const order = ['post name', 'post', 'state', 'department', 'ur', 'gen', 'ews', 'obc', 'sc', 'st', 'total'];
                                        const sortedKeys = rawKeys.sort((a, b) => {
                                            let ia = order.indexOf(a.toLowerCase());
                                            let ib = order.indexOf(b.toLowerCase());
                                            if (ia === -1) ia = 100; if (ib === -1) ib = 100;
                                            if (a.toLowerCase() === 'total') return 1;
                                            if (b.toLowerCase() === 'total') return -1;
                                            return ia - ib;
                                        });
                                        return sortedKeys.map(k => (
                                            <th class="border border-gray-300 px-2 py-2">{formatHeader(k)}</th>
                                        ));
                                    })()}
                                </tr>
                            </thead>
                            <tbody>
                            {post.stateWiseVacancy.map((row, i) => {
                                const rawKeys = Object.keys(row);
                                const order = ['post name', 'post', 'state', 'department', 'ur', 'gen', 'ews', 'obc', 'sc', 'st', 'total'];
                                const sortedKeys = rawKeys.sort((a, b) => {
                                    let ia = order.indexOf(a.toLowerCase());
                                    let ib = order.indexOf(b.toLowerCase());
                                    if (ia === -1) ia = 100; if (ib === -1) ib = 100;
                                    if (a.toLowerCase() === 'total') return 1;
                                    if (b.toLowerCase() === 'total') return -1;
                                    return ia - ib;
                                });
                                return (
                                    <tr class={`hover:bg-blue-50 transition ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                        {sortedKeys.map(key => (
                                            <td class={`border border-gray-300 px-2 py-2 ${key.toLowerCase().includes('post') ? 'font-bold text-left' : ''}`}>
                                                {row[key]}
                                            </td>
                                        ))}
                                    </tr>
                                )
                            })}
                            <tr class="bg-gray-200 font-bold">
                                {(() => {
                                     const sampleRow = post.stateWiseVacancy[0];
                                     const rawKeys = Object.keys(sampleRow);
                                     const order = ['post name', 'post', 'state', 'department', 'ur', 'gen', 'ews', 'obc', 'sc', 'st', 'total'];
                                     const sortedKeys = rawKeys.sort((a, b) => {
                                            let ia = order.indexOf(a.toLowerCase());
                                            let ib = order.indexOf(b.toLowerCase());
                                            if (ia === -1) ia = 100; if (ib === -1) ib = 100;
                                            if (a.toLowerCase() === 'total') return 1;
                                            if (b.toLowerCase() === 'total') return -1;
                                            return ia - ib;
                                     });
                                     return sortedKeys.map((key, index) => {
                                        if (index === 0) return <td class="border border-gray-300 px-2 py-2 text-right uppercase">Total</td>;
                                        const total = calculateTotal(post.stateWiseVacancy, key);
                                        return <td class="border border-gray-300 px-2 py-2 text-[#d32f2f]">{total || "-"}</td>;
                                     });
                                })()}
                            </tr>
                            </tbody>
                        </table>
                    </div>
                ) : (
                    post.stateWiseVacancy.map(block => (
                        <div class="mb-4 mt-2 px-2">
                            {block.title && <div class="bg-gray-200 px-3 py-1 font-bold text-sm text-gray-800 border border-gray-300 text-center uppercase mb-1">{block.title}</div>}
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse text-center">
                                    <thead class="bg-gray-100 font-bold text-gray-700 whitespace-nowrap uppercase text-xs">
                                        <tr>{Object.keys(block.data[0]).map(h => <th class="border border-gray-300 px-2 py-2">{formatHeader(h)}</th>)}</tr>
                                    </thead>
                                    <tbody>
                                        {block.data.map(row => (
                                            <tr class="hover:bg-white bg-gray-50">
                                                {Object.values(row).map(val => <td class="border border-gray-300 px-2 py-2">{val}</td>)}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ))
                )}
                </div>
            </div>
            )}

            {/* ELIGIBILITY */}
            {post.eligibility && (
                <div class="mb-6">
                    <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Eligibility Criteria</div>
                    <ul class="border border-gray-400 p-4 list-disc pl-8 text-sm text-gray-800 bg-gray-50 leading-relaxed">
                        {post.eligibility.map(item => <li class="mb-1" set:html={formatText(item)}></li>)}
                    </ul>
                </div>
            )}

            {/* SALARY */}
            {!isSimpleMode && (post.salary || post.salaryDetails) && (
            <div id="salary" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#008000] text-white text-center font-bold py-2 text-sm uppercase tracking-wide">Pay Scale / Salary Structure</div>
                {post.salaryDetails ? (
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse border border-gray-300">
                            <thead class="bg-green-50 text-green-900 uppercase text-xs">
                                <tr><th class="border border-gray-300 px-3 py-2 text-left">Post Name</th><th class="border border-gray-300 px-3 py-2 text-left">Salary Level</th></tr>
                            </thead>
                            <tbody>
                                {post.salaryDetails.map((row) => (
                                    <tr class="hover:bg-green-50 transition"><td class="border border-gray-300 px-3 py-2 font-medium">{row.post}</td><td class="border border-gray-300 px-3 py-2 font-bold text-green-700">{row.level}</td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                ) : (<div class="p-4 bg-gray-50 text-center text-green-800 font-bold border-t uppercase tracking-widest">{post.salary}</div>)}
            </div>
            )}

            {/* SELECTION PROCESS */}
            {post.selectionProcess && (
            <div id="selection" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Selection Process Steps</div>
                <div class="bg-white p-4"><ol class="list-decimal pl-6 space-y-2 text-sm text-gray-900 font-medium">{post.selectionProcess.map(s => <li class="tracking-wide">{s}</li>)}</ol></div>
            </div>
            )}

            {/* EXAM PATTERN */}
            {post.examPattern && (
            <div id="pattern" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Detailed Exam Pattern</div>
                <div class="bg-white p-4">
                    {Array.isArray(post.examPattern) ? (
                        post.examPattern.map(block => {
                            const tableData = block.table || block.data || block.tableData;
                            const isTable = block.type === 'table' || (Array.isArray(tableData) && tableData.length > 0);
                            
                            if (isTable && tableData && tableData[0]) {
                                return (
                                    <div class="mb-6 border border-gray-300">
                                        {block.title && <div class="bg-gray-200 px-3 py-2 font-bold text-sm text-gray-800 border-b border-gray-300 text-center uppercase">{block.title}</div>}
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm border-collapse text-center">
                                                <thead class="bg-gray-100 font-bold text-gray-700 text-xs uppercase">
                                                    <tr>
                                                        {Object.keys(tableData[0]).map(h => (
                                                            <th class="border border-gray-300 px-2 py-2">{formatHeader(h)}</th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {tableData.map(row => (
                                                        <tr class="hover:bg-white bg-gray-50 transition">
                                                            {Object.values(row).map(val => (
                                                                <td class="border border-gray-300 px-2 py-2">{val}</td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                );
                            }
                            const isText = block.type === 'text' || block.type === 'note' || block.content || typeof block.data === 'string';
                            if (isText) {
                                const textContent = block.content || block.data;
                                return (
                                    <div class="mb-4 p-3 bg-gray-50 border-l-4 border-blue-500">
                                        {block.title && <h4 class="font-bold text-gray-800 mb-1 uppercase text-xs">{block.title}</h4>}
                                        <p class="text-sm text-gray-700 leading-relaxed" set:html={formatText(textContent)}></p>
                                    </div>
                                );
                            }
                            return null;
                        })
                    ) : (
                        Object.entries(post.examPattern).map(([key, value]) => {
                             if(Array.isArray(value) && typeof value[0] === 'object') {
                                return (
                                    <div class="mb-4 border border-gray-300">
                                        <div class="bg-gray-200 px-3 py-1 font-bold text-sm text-gray-800 text-center uppercase">{formatHeader(key)}</div>
                                        <table class="w-full text-sm border-collapse text-center">
                                            <thead class="bg-gray-100 uppercase text-xs"><tr>{Object.keys(value[0]).map(h=><th class="border px-2 py-2">{h}</th>)}</tr></thead>
                                            <tbody>{value.map(r=>(<tr class="hover:bg-white"><td class="border px-2 py-2">{Object.values(r).map(v=><span class="block">{v}</span>)}</td></tr>))}</tbody>
                                        </table>
                                    </div>
                                )
                             }
                             if(typeof value === 'string') {
                                return (
                                    <div class="mb-2 p-2 bg-gray-50 text-sm">
                                        <strong class="uppercase text-xs">{formatHeader(key)}:</strong> {value}
                                    </div>
                                )
                             }
                             return null;
                        })
                    )}
                </div>
            </div>
            )}

            {/* EXTRA SECTIONS */}
            {post.extraSections && post.extraSections.length > 0 && (
                <div id="extra-sections" class="mb-6 scroll-mt-20">
                    {post.extraSections.map((section) => {
                        const tableData = section.table || section.data || section.tableData;
                        return (
                            <div class="mb-6 border border-gray-400">
                                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{section.title}</div>
                                <div class="bg-white">
                                    {tableData && (
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm border-collapse text-center">
                                                <thead class="bg-gray-100 font-bold text-gray-700 whitespace-nowrap uppercase text-xs">
                                                    <tr>{Object.keys(tableData[0]).map(h => (<th class="border border-gray-300 px-2 py-2">{formatHeader(h)}</th>))}</tr>
                                                </thead>
                                                <tbody>
                                                    {tableData.map((row, i) => (
                                                        <tr class={`hover:bg-blue-50 transition ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                            {Object.values(row).map(val => (<td class="border border-gray-300 px-2 py-2">{val}</td>))}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                    {section.list && (
                                        <div class="p-4 border-t border-gray-200">
                                            <ul class="list-disc pl-5 space-y-1 text-sm text-gray-800">
                                                {section.list.map(item => <li set:html={formatText(item)}></li>)}
                                            </ul>
                                        </div>
                                    )}
                                    {section.content && (
                                        <div class="p-4 border-t border-gray-200">
                                            <p class="text-sm text-gray-800 leading-relaxed" set:html={formatText(section.content)}></p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {/* SYLLABUS */}
            {post.syllabus && (
            <div id="syllabus" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Subject-wise Syllabus Topics</div>
                <div class="bg-white p-4">
                    {post.syllabus.intro && <p class="text-sm text-gray-700 mb-4 italic border-l-4 border-blue-500 pl-3 bg-blue-50 py-2">{post.syllabus.intro}</p>}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {post.syllabus.topics && post.syllabus.topics.map((subject) => (
                            <div class="border border-gray-300 rounded overflow-hidden hover:shadow-sm transition">
                                <div class="bg-gray-100 px-3 py-2 font-bold text-sm text-blue-800 border-b border-gray-300 uppercase tracking-wide">üìö {subject.subject}</div>
                                <div class="p-3 bg-white"><ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">{subject.details.map(topic => <li set:html={formatText(topic)}></li>)}</ul></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
            )}

            {/* HOW TO APPLY */}
            {post.howToApply && (
            <div class="mb-6 border border-gray-400">
                <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{stepsHeader}</div>
                <div class="bg-white p-4"><ol class="list-decimal pl-6 space-y-2 text-sm text-gray-800 font-medium">{post.howToApply.map(s => <li set:html={formatText(s)}></li>)}</ol></div>
            </div>
            )}

            {/* LINKS */}
            <div id="links" class="mb-6 border border-gray-400 scroll-mt-20">
                <div class="bg-[#d32f2f] text-white text-center font-bold py-2 text-lg uppercase tracking-wider">
                {isSimpleMode ? "Direct Download Links" : "Important Official Links"}
                </div>
                <div class="bg-white">
                    <table class="w-full text-sm md:text-base border-collapse">
                        <tbody>
                            {post.links && post.links.map((link, index) => {
                                const isInactive = link.isActive === false;
                                return (
                                    <tr class={`hover:bg-red-50 transition ${index !== post.links.length - 1 ? 'border-b border-gray-300' : ''}`}>
                                        <td class="px-4 py-3 font-bold text-gray-700 border-r border-gray-300 w-2/3 tracking-wide">
                                            {link.title}
                                            {link.note && <span class="block text-[10px] text-gray-500 font-normal italic mt-1">{link.note}</span>}
                                        </td>
                                        <td class="px-4 py-2 text-center">
                                            {isInactive ? (
                                                <span class="inline-flex items-center gap-1 px-4 py-1.5 rounded text-xs font-bold uppercase shadow-sm border bg-gray-300 text-gray-500 cursor-not-allowed border-gray-400">
                                                    Inactive üîí
                                                </span>
                                            ) : (
                                                <a href={link.url} target="_blank" class={`inline-flex items-center gap-1 px-4 py-1.5 rounded text-xs font-bold uppercase shadow-sm border ${getBtnStyle(link.title)}`}>
                                                    Click Here ‚Üó
                                                </a>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="text-center text-[11px] text-gray-400 mt-2 mb-6 uppercase tracking-tighter">Disclaimer: Information provided here is for quick reference. Verify all details on the official website before taking action.</div>

            <AdSlot type="square" />

            {/* FAQs */}
            {post.faqs && post.faqs.length > 0 && (
            <div id="faqs" class="mb-8 border border-gray-300 p-2 rounded bg-gray-50 scroll-mt-20">
                <h3 class="text-lg font-bold text-gray-800 mb-3 text-center uppercase tracking-widest border-b border-gray-200 pb-2">Common Questions (FAQs)</h3>
                <div class="space-y-2">
                {post.faqs.map((faq, i) => (
                    <details class="group bg-white border border-gray-300 rounded shadow-sm">
                    <summary class="font-bold cursor-pointer p-3 text-sm flex justify-between items-center text-gray-800 hover:bg-gray-100 transition">
                        <span class="text-[#d32f2f] mr-2">Q.{i+1}</span> {faq.question}
                        <span class="text-gray-500 group-open:rotate-180 transition">‚ñº</span>
                    </summary>
                    <div class="px-4 pb-3 pt-0 text-gray-600 text-sm leading-relaxed border-t border-gray-100 mt-2 font-medium italic"><strong>Ans:</strong> {faq.answer}</div>
                    </details>
                ))}
                </div>
            </div>
            )}

            {/* SOCIAL */}
            <div class="flex flex-wrap justify-center gap-3 mb-8">
                <a href={waLink} class="bg-[#25D366] hover:bg-[#20bd5a] text-white px-5 py-2.5 rounded shadow-md text-sm font-bold flex items-center gap-2 transform hover:-translate-y-1 transition uppercase tracking-wide"><span>Share on WhatsApp</span></a>
                <a href={tgLink} target="_blank" class="bg-[#229ED9] hover:bg-[#1f8bc1] text-white px-5 py-2.5 rounded shadow-md text-sm font-bold flex items-center gap-2 transform hover:-translate-y-1 transition uppercase tracking-wide"><span>Share on Telegram</span></a>
            </div>

            {/* RELATED JOBS */}
            {relatedPosts.length > 0 && (
                <div class="mt-8 pt-6 border-t-4 border-[#d32f2f]">
                    <h3 class="text-xl font-bold text-[#d32f2f] mb-4 pl-2 uppercase tracking-widest">More Related Updates</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {relatedPosts.map(p => (
                            <a href={`/${p.slug}`} class="block p-3 border border-gray-300 rounded hover:border-blue-500 hover:shadow-md transition bg-gray-50 hover:bg-white group">
                                <div class="text-sm font-bold text-gray-800 group-hover:text-blue-700 tracking-tight leading-snug">üëâ {p.shortTitle || p.title}</div>
                                <div class="text-xs text-gray-500 mt-1 uppercase font-mono tracking-tighter">üìÖ Posted: {p.postDate}</div>
                            </a>
                        ))}
                    </div>
                </div>
            )}

        </article>
    </main>

    {/* SIDEBAR */}
    <aside class="hidden lg:block w-[300px] flex-shrink-0">
        <div class="sticky top-4 space-y-6">
            <a href="https://whatsapp.com/channel/0029Vb7TcG06LwHoTXhZKn2D" target="_blank" class="block bg-white border-l-4 border-[#25D366] p-4 shadow-sm hover:shadow-md transition rounded">
                <div class="flex items-center gap-3"><div class="bg-[#25D366] text-white p-2 rounded-full"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg></div><div><div class="text-xs text-gray-500 font-bold uppercase">Join us on</div><div class="text-lg font-bold text-gray-800 leading-none">WhatsApp</div></div></div>
            </a>
            <a href="https://t.me/toponlineform" target="_blank" class="block bg-white border-l-4 border-[#229ED9] p-4 shadow-sm hover:shadow-md transition rounded">
                <div class="flex items-center gap-3"><div class="bg-[#229ED9] text-white p-2 rounded-full"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.694 0Zm5.216 8.784-1.76 8.297c-.13.587-.48.73-.974.454l-2.696-1.986-1.3 1.253c-.144.144-.265.265-.54.265l.192-2.738 4.985-4.506c.217-.193-.047-.3-.337-.107l-6.16 3.878-2.656-.83c-.577-.18-.588-.577.12-.852l10.378-4.004c.48-.173.9.117.748.876Z"/></svg></div><div><div class="text-xs text-gray-500 font-bold uppercase">Join us on</div><div class="text-lg font-bold text-gray-800 leading-none">Telegram</div></div></div>
            </a>
            <AdSlot type="square" />
        </div>
    </aside>

  </div>

  {/* ‚úÖ INFINITY PRO SEO SCHEMA */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
      // 1. JOB POSTING
      {
        "@type": "JobPosting",
        "title": post.title,
        "description": post.shortInfo,
        "datePosted": post.postDate ? new Date(post.postDate.split('/').reverse().join('-')).toISOString() : new Date().toISOString(),
        "validThrough": post.importantDates?.find(d => d.label.toLowerCase().includes("last date"))?.value.replace(/\//g, '-') || "2026-12-31",
        "hiringOrganization": { 
          "@type": "Organization", 
          "name": post.board || (post.state ? post.state + " Recruitment Board" : "Government Recruitment Board"),
          "logo": "https://toponlineform.com/gov-logo.png" 
        },
        "jobLocation": {
          "@type": "Place",
          "address": {
            "@type": "PostalAddress",
            "addressCountry": "IN",
            "addressRegion": post.state || "India"
          }
        },
        ...(post.salary ? {
            "baseSalary": {
                "@type": "MonetaryAmount",
                "currency": "INR",
                "value": {
                    "@type": "QuantitativeValue",
                    "value": parseInt(post.salary.replace(/[^0-9]/g, '')) || 0,
                    "unitText": "MONTH"
                }
            }
        } : {})
      },
      // 2. NEWS ARTICLE
      {
        "@type": "NewsArticle",
        "headline": post.title,
        "datePublished": post.postDate ? new Date(post.postDate.split('/').reverse().join('-')).toISOString() : new Date().toISOString(),
        "dateModified": post.updatedDate ? new Date(post.updatedDate.split('/').reverse().join('-')).toISOString() : new Date().toISOString(),
        "author": {
          "@type": "Organization",
          "name": "Top Online Form",
          "url": "https://toponlineform.com"
        },
        "publisher": {
          "@type": "Organization",
          "name": "Top Online Form",
          "logo": {
            "@type": "ImageObject",
            "url": "https://toponlineform.com/logo.png"
          }
        }
      }
    ]
  })} />

  {/* ‚è≥ LIVE COUNTDOWN SCRIPT */}
  <script>
    const box = document.getElementById('countdown-box');
    const label = document.getElementById('timer-label');
    const display = document.getElementById('timer-display');
    
    if (box && display && label) {
        const targetDate = new Date(box.dataset.date);
        targetDate.setHours(23, 59, 59); // End of the day

        const updateTimer = () => {
            const now = new Date();
            const diff = targetDate - now;

            if (diff <= 0) {
                // EXPIRED STATE
                display.innerText = "Application Closed ‚ùå";
                label.innerText = "Status:";
                box.classList.remove('bg-red-50', 'border-red-200', 'animate-pulse');
                box.classList.add('bg-gray-100', 'border-gray-300', 'opacity-70');
                display.classList.remove('text-red-700');
                display.classList.add('text-gray-500');
                clearInterval(interval);
                box.classList.remove('hidden');
                return;
            }

            // Calculations
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            // COLOR LOGIC (Dynamic Urgency)
            if (days > 10) {
                // Safe Zone (Green)
                box.classList.remove('bg-red-50', 'border-red-200', 'bg-yellow-50', 'border-yellow-200');
                box.classList.add('bg-green-50', 'border-green-200');
                label.innerText = "Ends In:";
                label.className = "text-xs font-bold uppercase tracking-widest text-green-700";
                display.className = "text-lg md:text-xl font-black font-mono tracking-wide text-green-800";
            } else if (days > 3) {
                // Warning Zone (Yellow)
                box.classList.remove('bg-green-50', 'border-green-200', 'bg-red-50', 'border-red-200');
                box.classList.add('bg-yellow-50', 'border-yellow-300');
                label.innerText = "Hurry Up! Ends In:";
                label.className = "text-xs font-bold uppercase tracking-widest text-yellow-800";
                display.className = "text-lg md:text-xl font-black font-mono tracking-wide text-yellow-900";
            } else {
                // Critical Zone (Red Blinking)
                box.classList.remove('bg-green-50', 'border-green-200', 'bg-yellow-50', 'border-yellow-300');
                box.classList.add('bg-red-50', 'border-red-200');
                label.innerText = "CRITICAL! Application Closing In:";
                label.className = "text-xs font-bold uppercase tracking-widest text-red-600 animate-pulse";
                display.className = "text-lg md:text-xl font-black font-mono tracking-wide text-red-700";
            }

            display.innerText = `${days}d : ${hours}h : ${minutes}m : ${seconds}s`;
            box.classList.remove('hidden');
        };

        const interval = setInterval(updateTimer, 1000);
        updateTimer(); // Initial call
    }
  </script>

</Layout>

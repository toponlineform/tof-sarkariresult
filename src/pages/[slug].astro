---
import Layout from '../layouts/Layout.astro';
import { allPosts } from '../data/index.js';

// --- 1. DATA FETCHING ---
export async function getStaticPaths() {
  return allPosts.map((post) => {
    const relatedPosts = allPosts
      .filter(p => p.category === post.category && p.slug !== post.slug)
      .sort((a, b) => {
          // Date sorting logic
          const parseDate = (d) => {
             if(!d) return 0;
             const p = d.trim().split('/');
             return new Date(`${p[2]}-${p[1]}-${p[0]}`).getTime();
          };
          return parseDate(b.updatedDate || b.postDate) - parseDate(a.updatedDate || a.postDate);
      })
      .slice(0, 6);

    return { params: { slug: post.slug }, props: { post, relatedPosts } };
  });
}

const { post, relatedPosts } = Astro.props;

// --- üß† 2. LOGIC ADAPTER (React Logic converted to Astro) ---

// A. SIMPLE MODE LOGIC (Adapted from React)
// Agar Syllabus/Previous Paper/Answer Key hai toh Age/Vacancy mat dikhao
const catLower = post.category.toLowerCase();
const isSimpleMode = catLower.includes("syllabus") || catLower.includes("previous") || catLower.includes("paper") || catLower.includes("answer key");

// B. DYNAMIC HEADER LOGIC (Adapted from React)
// Category k hisaab se "How to Apply" ka text change karo
let stepsHeader = "How to Apply";
if (isSimpleMode) stepsHeader = "How to Download";
else if (catLower.includes("admit card")) stepsHeader = "How to Download Admit Card";
else if (catLower.includes("result")) stepsHeader = "How to Check Result";
else if (catLower.includes("admission")) stepsHeader = "How to Apply for Admission";

// C. AUTO TOTAL LOGIC (Adapted from React)
// Sirf numeric columns ka total karo, Age/Year/Code ko chhod do
const calculateTotal = (data, key) => {
    if (!data || !key) return null;
    const skipKeys = ['age', 'year', 'code', 's.no', 'serial', 'qualification'];
    if (skipKeys.some(k => key.toLowerCase().includes(k))) return null;

    let total = 0;
    let hasNumbers = false;
    
    for (let item of data) {
        let val = item[key];
        if (!val) continue;
        // Clean value (remove commas, spaces)
        let clean = String(val).replace(/,/g, '').trim();
        if (clean && !isNaN(clean)) {
            total += parseFloat(clean);
            hasNumbers = true;
        } else {
            // Agar ek bhi non-number mila (jaise text), toh total mat karo
            return null;
        }
    }
    return hasNumbers ? total : null;
};

// D. HEADER FORMATTER (camelCase to Title Case)
const formatHeader = (key) => {
    // React code se list uthayi hai
    const upperKeys = ["ur", "obc", "sc", "st", "ews", "pwbd", "esm", "gen", "ph", "cbt", "pet"];
    if (upperKeys.includes(key.toLowerCase())) return key.toUpperCase();
    return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).trim();
};

// E. INFINITE DATA FINDER (New Logic)
// Wo keys dhundo jo standard nahi hain (jaise branchWiseVacancy)
const standardKeys = [
  'id', 'slug', 'title', 'shortTitle', 'category', 'postDate', 'updatedDate', 
  'shortInfo', 'importantDates', 'applicationFee', 'links', 'faqs', 'tags', 
  'state', 'ageLimit', 'ageRelaxation', 'vacancyDetails', 'stateWiseVacancy',
  'salary', 'salaryDetails', 'selectionProcess', 'examPattern', 'howToApply', 
  'eligibility', 'extraSections' // We handle these explicitly
];
const dynamicKeys = Object.keys(post).filter(key => !standardKeys.includes(key));

// Helper: Guess Data Type
const getDataType = (data) => {
    if (Array.isArray(data) && data.length > 0) {
        return typeof data[0] === 'object' ? 'table' : 'list';
    }
    return 'text';
};

// Share Links
const shareUrl = `https://toponlineform.com/${post.slug}`;
const shareTitle = post.title;
const waLink = `https://api.whatsapp.com/send?text=‚úÖ *${encodeURIComponent(shareTitle)}* üëá%0A%0A${encodeURIComponent(shareUrl)}`;
const tgLink = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=‚úÖ *${encodeURIComponent(shareTitle)}* üëá`;

// Text Formatter
const formatText = (text) => String(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br />');

---

<Layout title={post.title} description={post.shortInfo} keywords={post.tags}>
  
  {/* üçû BREADCRUMBS */}
  <nav class="flex text-xs text-gray-500 mb-2 px-1 font-medium overflow-x-auto whitespace-nowrap">
    <a href="/" class="hover:text-blue-700">Home</a> <span class="mx-1">‚Ä∫</span>
    <a href={`/${post.category.toLowerCase().replace(/\s+/g, '-')}`} class="hover:text-blue-700 text-blue-600">{post.category}</a> <span class="mx-1">‚Ä∫</span>
    <span class="text-gray-600 truncate max-w-[250px]">{post.shortTitle || "Details"}</span>
  </nav>

  {/* üìÑ MAIN CARD */}
  <article class="bg-white p-3 md:p-5 border border-gray-400 font-sans mb-10 shadow-sm">
    
    {/* 1. HEADER */}
    <header class="text-center mb-6">
      <h1 class="text-xl md:text-2xl lg:text-3xl font-extrabold text-[#d32f2f] mb-3 leading-snug">
        {post.title}
      </h1>
      
      <div class="flex flex-wrap justify-center gap-4 text-sm text-gray-700 font-bold mb-4">
        <span>üìÖ Post Date: {post.postDate}</span>
        {post.updatedDate && <span class="text-green-700">| üìù Updated: {post.updatedDate}</span>}
      </div>

      {/* Short Info (Yellow Box) */}
      {post.shortInfo && (
        <div class="text-left bg-[#fffae6] border border-[#f0c14b] p-3 text-sm md:text-base text-gray-800 leading-relaxed">
          <p><strong class="text-[#d32f2f]">Short Information:</strong> <span set:html={formatText(post.shortInfo)}></span></p>
        </div>
      )}
    </header>

    {/* 2. DATES & FEES (Only if NOT Simple Mode) */}
    {!isSimpleMode && post.importantDates && post.importantDates.length > 0 && (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-0 border border-gray-400 mb-6">
      <div class="border-b md:border-b-0 md:border-r border-gray-400">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Important Dates</div>
        <div class="bg-white p-2">
          <ul class="space-y-2 text-sm">
            {post.importantDates.map((date) => (
              <li class="flex justify-between border-b border-gray-200 last:border-0 pb-1">
                <span class="font-bold text-gray-700">{date.label}</span><span class="text-gray-900 font-medium">{date.value}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
      <div>
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Application Fee</div>
        <div class="bg-white p-2">
          {post.applicationFee ? (
              <ul class="space-y-2 text-sm">
                {post.applicationFee.map((fee) => (
                  <li class="flex justify-between border-b border-gray-200 last:border-0 pb-1">
                    <span class="font-bold text-gray-700">{fee.category}</span><span class="text-gray-900 font-medium">{fee.amount}</span>
                  </li>
                ))}
              </ul>
          ) : (<div class="text-center text-sm py-2">Check Notification</div>)}
          <div class="mt-2 text-[11px] text-gray-500 text-center italic">Pay via: Net Banking / Debit Card / Credit Card / UPI</div>
        </div>
      </div>
    </div>
    )}

    {/* 3. AGE LIMIT & VACANCY (Smart Logic: Show only if data exists & Not Simple Mode) */}
    {!isSimpleMode && (post.ageLimit || post.vacancyDetails) && (
    <div class="mb-6 border border-gray-400">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Vacancy Details & Age Limit</div>
        
        {post.ageLimit && (
            <div class="p-3 text-center border-b border-gray-300 bg-gray-50">
                <p class="text-sm font-bold text-gray-800">Age Limit: <span class="font-normal">{post.ageLimit}</span></p>
                {post.ageRelaxation && <p class="text-xs text-gray-500 mt-1">({post.ageRelaxation})</p>}
            </div>
        )}

        {post.vacancyDetails && (
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse text-center">
                    <thead class="bg-gray-100 text-gray-800 text-xs uppercase font-bold">
                        <tr>
                            <th class="border border-gray-300 px-2 py-2 text-left">Post Name</th>
                            <th class="border border-gray-300 px-2 py-2">Total</th>
                            <th class="border border-gray-300 px-2 py-2 text-left">Eligibility</th>
                        </tr>
                    </thead>
                    <tbody>
                        {post.vacancyDetails.map((v) => (
                            <tr class="hover:bg-yellow-50">
                                <td class="border border-gray-300 px-2 py-2 text-left font-bold text-gray-700">{v.postName}</td>
                                <td class="border border-gray-300 px-2 py-2 font-bold text-[#d32f2f]">{v.totalPost || v.total}</td>
                                <td class="border border-gray-300 px-2 py-2 text-left text-gray-600" set:html={formatText(v.eligibility)}></td>
                            </tr>
                        ))}
                        {/* Logic: Auto Total for Main Vacancy */}
                        {(() => {
                            const total = calculateTotal(post.vacancyDetails, 'total') || calculateTotal(post.vacancyDetails, 'totalPost');
                            if(total) return (<tr class="bg-gray-200 font-bold"><td class="border px-2 py-2 text-right">Total</td><td class="border px-2 py-2 text-[#d32f2f]">{total}</td><td class="border px-2 py-2"></td></tr>);
                        })()}
                    </tbody>
                </table>
            </div>
        )}
    </div>
    )}

    {/* 4. STATE/CATEGORY VACANCY (Logic: Skip total for 'Qualification' etc) */}
    {!isSimpleMode && post.stateWiseVacancy && post.stateWiseVacancy.length > 0 && (
      <div class="mb-6 border border-gray-400">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{post.vacancyTableTitle || "Category Wise Vacancy"}</div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm border-collapse border border-gray-300 text-center">
            <thead class="bg-gray-100 font-bold text-gray-700 whitespace-nowrap">
              <tr>{Object.keys(post.stateWiseVacancy[0]).map(k => <th class="border border-gray-300 px-2 py-2">{formatHeader(k)}</th>)}</tr>
            </thead>
            <tbody>
              {post.stateWiseVacancy.map((row, i) => (
                <tr class={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                  {Object.values(row).map(val => <td class="border border-gray-300 px-2 py-2 font-medium">{val}</td>)}
                </tr>
              ))}
              {/* Logic: Smart Auto Total Row */}
              <tr class="bg-gray-200 font-bold">
                 {Object.keys(post.stateWiseVacancy[0]).map((key, index) => {
                     if (index === 0) return <td class="border border-gray-300 px-2 py-2 text-right">Total</td>;
                     const total = calculateTotal(post.stateWiseVacancy, key);
                     return <td class="border border-gray-300 px-2 py-2 text-[#d32f2f]">{total || "-"}</td>;
                 })}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    )}

    {/* 5. ELIGIBILITY LIST */}
    {post.eligibility && (
        <div class="mb-6">
            <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Eligibility Criteria</div>
            <ul class="border border-gray-400 p-4 list-disc pl-8 text-sm text-gray-800 bg-gray-50">
                {post.eligibility.map(item => <li class="mb-1" set:html={formatText(item)}></li>)}
            </ul>
        </div>
    )}

    {/* üî• 6. INFINITE DATA RENDERER (Smartest Logic) üî• */}
    {/* Ye section 'branchWiseVacancy', 'regionCoverage' etc ko dhund k display karega */}
    {dynamicKeys.map((key) => {
        const data = post[key];
        const type = getDataType(data);
        const title = formatHeader(key);

        if (type === 'table') {
            const headers = Object.keys(data[0]);
            return (
                <div class="mb-6 border border-gray-400">
                    <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{title}</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse border border-gray-300 text-center">
                            <thead class="bg-gray-100 font-bold text-gray-700 whitespace-nowrap">
                                <tr>{headers.map(h => <th class="border border-gray-300 px-2 py-2">{formatHeader(h)}</th>)}</tr>
                            </thead>
                            <tbody>
                                {data.map((row, i) => (
                                    <tr class={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                        {Object.values(row).map(val => <td class="border border-gray-300 px-2 py-2" set:html={formatText(val)}></td>)}
                                    </tr>
                                ))}
                                {/* Auto Total for Infinite Tables */}
                                <tr class="bg-gray-200 font-bold">
                                    {headers.map((h, i) => {
                                        if(i===0) return <td class="border border-gray-300 px-2 py-2 text-right">Total</td>;
                                        const t = calculateTotal(data, h);
                                        return <td class="border border-gray-300 px-2 py-2 text-[#d32f2f]">{t || ""}</td>;
                                    })}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        if (type === 'list') {
            return (
                <div class="mb-6 border border-gray-400">
                    <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{title}</div>
                    <div class="bg-white p-4"><ul class="list-disc pl-6 space-y-1 text-sm text-gray-800">{data.map(item => <li set:html={formatText(item)}></li>)}</ul></div>
                </div>
            );
        }
        return null;
    })}

    {/* 7. SALARY */}
    {!isSimpleMode && (post.salary || post.salaryDetails) && (
      <div class="mb-6 border border-gray-400">
        <div class="bg-[#008000] text-white text-center font-bold py-2 text-sm uppercase">Pay Scale / Salary</div>
        {post.salaryDetails ? (
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse border border-gray-300">
                    <thead class="bg-green-50 text-green-900">
                        <tr><th class="border border-gray-300 px-3 py-2 text-left">Post Name</th><th class="border border-gray-300 px-3 py-2 text-left">Level</th></tr>
                    </thead>
                    <tbody>
                        {post.salaryDetails.map((row) => (
                            <tr class="hover:bg-green-50"><td class="border border-gray-300 px-3 py-2 font-medium">{row.post}</td><td class="border border-gray-300 px-3 py-2 font-bold">{row.level}</td></tr>
                        ))}
                    </tbody>
                </table>
            </div>
        ) : (<div class="p-4 bg-gray-50 text-center text-green-800 font-bold border-t">{post.salary}</div>)}
      </div>
    )}

    {/* 8. EXAM PATTERN & SELECTION */}
    {post.selectionProcess && (
      <div class="mb-6 border border-gray-400">
         <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Selection Process</div>
         <div class="bg-white p-4"><ol class="list-decimal pl-6 space-y-1 text-sm text-gray-900 font-medium">{post.selectionProcess.map(s => <li>{s}</li>)}</ol></div>
      </div>
    )}

    {post.examPattern && (
      <div class="mb-6">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Exam Pattern & Syllabus</div>
        <div class="border border-gray-400 p-2 bg-gray-50">
            {post.examPattern.details && <ul class="list-disc pl-6 text-sm text-gray-800 space-y-1 mb-4">{post.examPattern.details.map(d => <li set:html={formatText(d)}></li>)}</ul>}
            
            {/* Logic: Render all stages dynamically */}
            {[
               post.examPattern.table ? { title: "Exam Pattern", data: post.examPattern.table } : null,
               post.examPattern.tier1 ? { title: "Tier-I", data: post.examPattern.tier1 } : null,
               post.examPattern.tier2 ? { title: "Tier-II", data: post.examPattern.tier2 } : null,
               post.examPattern.cbt1 ? { title: post.examPattern.cbt1Title || "CBT-1", data: post.examPattern.cbt1 } : null,
               post.examPattern.pet ? { title: "Physical Test (PET)", tableType: 'pet', data: post.examPattern.pet } : null,
               ...(post.examPattern.stages || [])
            ].filter(Boolean).map(stage => (
              <div class="mb-4 bg-white border border-gray-300">
                <div class="bg-gray-200 px-3 py-1 font-bold text-sm text-gray-800 border-b border-gray-300">{stage.title}</div>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm border-collapse text-center">
                    <thead class="bg-gray-100 text-gray-800 text-xs uppercase">
                        {stage.tableType === 'pet' || (stage.data[0] && stage.data[0].activity)
                           ? <tr><th class="border px-2 py-2">Activity</th><th class="border px-2 py-2">Male</th><th class="border px-2 py-2">Female</th></tr>
                           : <tr><th class="border px-2 py-2">Subject</th><th class="border px-2 py-2">Qs</th><th class="border px-2 py-2">Marks</th></tr>
                        }
                    </thead>
                    <tbody>
                      {stage.data.map(r => (
                        <tr class="hover:bg-gray-50">
                           {stage.tableType === 'pet' || r.activity ? (
                             <><td class="border border-gray-300 px-2 py-1 text-left">{r.activity}</td><td class="border border-gray-300 px-2 py-1">{r.male}</td><td class="border border-gray-300 px-2 py-1">{r.female}</td></>
                           ) : (
                             <><td class="border border-gray-300 px-2 py-1 text-left">{r.subject}</td><td class="border border-gray-300 px-2 py-1">{r.questions}</td><td class="border border-gray-300 px-2 py-1">{r.marks}</td></>
                           )}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))}
        </div>
      </div>
    )}

    {/* 9. HOW TO APPLY (Dynamic Header) */}
    {post.howToApply && (
      <div class="mb-6 border border-gray-400">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{stepsHeader}</div>
        <div class="bg-white p-4"><ol class="list-decimal pl-6 space-y-2 text-sm text-gray-800">{post.howToApply.map(s => <li set:html={formatText(s)}></li>)}</ol></div>
      </div>
    )}

    {/* 10. IMPORTANT LINKS (Logic: Table format) */}
    <div class="mb-8 border border-gray-400">
        <div class="bg-[#d32f2f] text-white text-center font-bold py-2 text-lg uppercase">
          {isSimpleMode ? "Download Links" : "Important Links"}
        </div>
        <div class="bg-white">
            <table class="w-full text-sm md:text-base border-collapse">
                <tbody>
                    {post.links && post.links.map((link, index) => (
                        <tr class={`hover:bg-red-50 transition ${index !== post.links.length - 1 ? 'border-b border-gray-300' : ''}`}>
                            <td class="px-4 py-3 font-bold text-gray-700 border-r border-gray-300 w-2/3">{link.title}</td>
                            <td class="px-4 py-2 text-center">
                                {/* Hybrid Logic: Title check for button color */}
                                <a href={link.url} target="_blank" class={`inline-flex items-center gap-1 px-4 py-1.5 rounded text-xs font-bold uppercase shadow-sm text-white ${link.title.toLowerCase().includes('apply') ? 'bg-[#1a56db]' : 'bg-[#2e7d32]'} hover:opacity-90`}>
                                    Click Here ‚Üó
                                </a>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    </div>

    {/* 11. FAQs */}
    {post.faqs && (
      <div class="mb-8 border border-gray-300 p-2 rounded bg-gray-50">
        <h3 class="text-lg font-bold text-gray-800 mb-3 text-center uppercase">Frequently Asked Questions</h3>
        <div class="space-y-2">
          {post.faqs.map((faq, i) => (
            <details class="group bg-white border border-gray-300 rounded">
              <summary class="font-semibold cursor-pointer p-3 text-sm flex justify-between items-center text-gray-800 hover:bg-gray-100">
                <span class="text-[#d32f2f] mr-2">Q.{i+1}</span> {faq.question}
                <span class="text-gray-500 group-open:rotate-180 transition">‚ñº</span>
              </summary>
              <div class="px-4 pb-3 pt-0 text-gray-600 text-sm leading-relaxed border-t border-gray-100 mt-2"><strong>Ans:</strong> {faq.answer}</div>
            </details>
          ))}
        </div>
      </div>
    )}

    {/* SHARE */}
    <div class="flex justify-center gap-4 mb-8">
        <a href={waLink} target="_blank" class="bg-[#25D366] hover:bg-[#20bd5a] text-white px-6 py-3 rounded-full shadow-md text-sm font-bold flex items-center gap-2">Share on WhatsApp ‚úàÔ∏è</a>
    </div>

  </article>

  {/* SEO SCHEMA */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "JobPosting",
        "title": post.title,
        "description": post.shortInfo,
        "datePosted": post.postDate ? new Date(post.postDate.split('/').reverse().join('-')).toISOString() : new Date().toISOString(),
        "validThrough": post.importantDates?.find(d => d.label.toLowerCase().includes("last date"))?.value.replace(/\//g, '-') || "2026-12-31",
        "hiringOrganization": { "@type": "Organization", "name": "Top Online Form", "url": "https://toponlineform.com" },
        "jobLocation": { "@type": "Place", "address": { "@type": "PostalAddress", "addressCountry": "IN", "addressRegion": post.state || "India" } }
      }
    ]
  })} />

</Layout>

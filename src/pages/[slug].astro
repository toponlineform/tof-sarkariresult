---
import Layout from '../layouts/Layout.astro';
import { allPosts } from '../data/index.js';

// --- 1. DATA FETCHING ---
export async function getStaticPaths() {
  return allPosts.map((post) => {
    const relatedPosts = allPosts
      .filter(p => p.category === post.category && p.slug !== post.slug)
      .sort((a, b) => new Date(b.postDate) - new Date(a.postDate)) // Simplistic sort
      .slice(0, 6);
    return { params: { slug: post.slug }, props: { post, relatedPosts } };
  });
}

const { post, relatedPosts } = Astro.props;

// --- üß† 2. UNIVERSAL LOGIC ENGINE (THE BRAIN) ---

// A. Keys jo hume "Auto Loop" mein nahi dikhani (kyunki ye hum manually upar/niche dikha rahe hain)
const ignoredKeys = [
  'id', 'slug', 'title', 'shortTitle', 'category', 'postDate', 'updatedDate', 
  'shortInfo', 'importantDates', 'applicationFee', 'links', 'faqs', 'tags', 
  'state', 'ageLimit', 'ageRelaxation', 'vacancyDetails'
];

// B. Baki sab keys dhundo (Jo aapne nayi add ki hain)
const dynamicKeys = Object.keys(post).filter(key => !ignoredKeys.includes(key));

// C. Helper: CamelCase to Title Case (e.g. "branchWiseVacancy" -> "Branch Wise Vacancy")
const formatTitle = (key) => {
  const result = key.replace(/([A-Z])/g, " $1");
  return result.charAt(0).toUpperCase() + result.slice(1);
};

// D. Helper: Content Text Formatter
const formatText = (text) => {
  if (!text) return "";
  return String(text)
    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900 font-bold">$1</strong>') // Bold
    .replace(/\n/g, '<br />'); // New line
};

// E. Helper: Check Data Type
const getDataType = (data) => {
    if (Array.isArray(data)) {
        if (data.length > 0 && typeof data[0] === 'object') return 'table'; // Array of Objects = Table
        return 'list'; // Array of Strings = List
    }
    if (typeof data === 'object' && data !== null) return 'complex-object'; // Nested Object
    return 'text'; // Simple String
};

// F. Helper: Auto Total Logic
const calculateTotal = (data, key) => {
    let total = 0;
    let isNumeric = true;
    for (let item of data) {
        let val = String(item[key] || '').replace(/,/g, '').trim();
        if (!val || isNaN(val)) { isNumeric = false; break; }
        total += parseFloat(val);
    }
    return isNumeric && total > 0 ? total : null;
};

// G. Helper: Button Color
const getBtnStyle = (title) => {
  const t = title.toLowerCase();
  if (t.includes('apply') || t.includes('login') || t.includes('registration')) return 'bg-blue-600 hover:bg-blue-700 text-white';
  if (t.includes('download') || t.includes('notice') || t.includes('result')) return 'bg-red-600 hover:bg-red-700 text-white';
  return 'bg-green-600 hover:bg-green-700 text-white';
};

// Social Links
const shareUrl = `https://toponlineform.com/${post.slug}`;
const waLink = `https://api.whatsapp.com/send?text=‚úÖ *${encodeURIComponent(post.title)}* üëá%0A%0A${encodeURIComponent(shareUrl)}`;
const tgLink = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=‚úÖ *${encodeURIComponent(post.title)}* üëá`;

---

<Layout title={post.title} description={post.shortInfo} keywords={post.tags}>

  {/* Breadcrumb */}
  <nav class="flex text-xs text-gray-500 mb-3 px-1 font-medium overflow-x-auto whitespace-nowrap">
    <a href="/" class="hover:text-blue-700">Home</a> <span class="mx-1">‚Ä∫</span>
    <a href={`/${post.category.toLowerCase().replace(/\s+/g, '-')}`} class="hover:text-blue-700 text-blue-600">{post.category}</a> <span class="mx-1">‚Ä∫</span>
    <span class="text-gray-600">{post.shortTitle || "Details"}</span>
  </nav>

  <article class="bg-white p-3 md:p-5 border border-gray-300 shadow-sm rounded-sm font-sans mb-10">

    {/* 1. HEADER & SHORT INFO */}
    <header class="text-center mb-6">
      <h1 class="text-xl md:text-2xl lg:text-3xl font-extrabold text-[#d91e18] mb-3 leading-snug">{post.title}</h1>
      <div class="flex flex-wrap justify-center gap-3 text-xs md:text-sm text-gray-600 font-bold mb-4">
        <span class="bg-gray-100 px-2 py-1 rounded border border-gray-200">üìÖ Post: {post.postDate}</span>
        {post.updatedDate && <span class="bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200">üìù Update: {post.updatedDate}</span>}
      </div>
      {post.shortInfo && (
        <div class="text-left bg-[#fffae6] border-l-4 border-[#f0c14b] p-4 text-sm text-gray-800 leading-relaxed shadow-sm my-4">
          <p><strong class="text-[#b91c1c]">Short Info:</strong> <span set:html={formatText(post.shortInfo)}></span></p>
        </div>
      )}
    </header>

    {/* 2. DATES & FEES (Standard Fixed Layout) */}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      {/* Dates */}
      <div class="border border-gray-300 rounded-sm overflow-hidden">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Important Dates</div>
        <div class="bg-white p-2">
          <ul class="space-y-2 text-sm">
            {post.importantDates?.map((d) => (
              <li class="flex justify-between border-b border-gray-100 last:border-0 pb-1">
                <span class="font-bold text-gray-700">{d.label}</span><span class="text-gray-900 font-medium">{d.value}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
      {/* Fees */}
      <div class="border border-gray-300 rounded-sm overflow-hidden">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Application Fee</div>
        <div class="bg-white p-2">
          <ul class="space-y-2 text-sm">
            {post.applicationFee?.map((f) => (
              <li class="flex justify-between border-b border-gray-100 last:border-0 pb-1">
                <span class="font-bold text-gray-700">{f.category}</span><span class="text-gray-900 font-medium">{f.amount}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>

    {/* 3. MAIN VACANCY & AGE (Standard Fixed Layout) */}
    {(post.vacancyDetails || post.ageLimit) && (
      <div class="mb-8 border border-gray-300 rounded-sm overflow-hidden">
        <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">Vacancy Details & Eligibility</div>
        {post.ageLimit && (
            <div class="p-3 bg-gray-50 border-b border-gray-300 text-center">
                <p class="text-sm font-bold text-gray-800">Age Limit: <span class="font-normal">{post.ageLimit}</span></p>
                {post.ageRelaxation && <p class="text-xs text-gray-500 mt-1">({post.ageRelaxation})</p>}
            </div>
        )}
        {post.vacancyDetails && (
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse">
                    <thead class="bg-gray-100 text-gray-800 text-xs uppercase">
                        <tr>
                            <th class="border border-gray-300 px-3 py-2 text-left">Post Name</th>
                            <th class="border border-gray-300 px-3 py-2 text-center">Total</th>
                            <th class="border border-gray-300 px-3 py-2 text-left">Eligibility</th>
                        </tr>
                    </thead>
                    <tbody>
                        {post.vacancyDetails.map((v) => (
                            <tr class="hover:bg-yellow-50">
                                <td class="border border-gray-300 px-3 py-2 font-bold text-gray-700">{v.postName}</td>
                                <td class="border border-gray-300 px-3 py-2 text-center font-bold text-[#d91e18]">{v.totalPost || v.total}</td>
                                <td class="border border-gray-300 px-3 py-2 text-gray-600" set:html={formatText(v.eligibility)}></td>
                            </tr>
                        ))}
                        {/* Auto Total for Main Vacancy */}
                        {(() => {
                            const total = calculateTotal(post.vacancyDetails, 'total') || calculateTotal(post.vacancyDetails, 'totalPost');
                            if(total) return (<tr class="bg-gray-200 font-bold"><td class="border px-3 py-2 text-right">Total</td><td class="border px-3 py-2 text-center text-red-600">{total}</td><td class="border px-3 py-2"></td></tr>);
                        })()}
                    </tbody>
                </table>
            </div>
        )}
      </div>
    )}

    {/* üî• 4. INFINITE AUTO-RENDERER (The Magic Part) üî• */}
    {dynamicKeys.map((key) => {
        const data = post[key];
        const type = getDataType(data);
        const title = formatTitle(key); // e.g. "documentsRequired" -> "Documents Required"

        // SCENARIO A: TABLE (Array of Objects)
        if (type === 'table') {
            const headers = Object.keys(data[0]);
            return (
                <div class="mb-8 border border-gray-300 rounded-sm overflow-hidden">
                    <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{title}</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse text-center">
                            <thead class="bg-gray-100 font-bold text-gray-700 whitespace-nowrap">
                                <tr>{headers.map(h => <th class="border border-gray-300 px-3 py-2 capitalize">{h.replace(/_/g, ' ')}</th>)}</tr>
                            </thead>
                            <tbody>
                                {data.map((row, i) => (
                                    <tr class={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                        {Object.values(row).map(val => <td class="border border-gray-300 px-3 py-2 font-medium whitespace-nowrap" set:html={formatText(val)}></td>)}
                                    </tr>
                                ))}
                                {/* Auto Total for Dynamic Tables */}
                                {(() => {
                                    const lastKey = headers[headers.length - 1];
                                    const total = calculateTotal(data, lastKey);
                                    if(total) return (<tr class="bg-gray-200 font-bold"><td class="border px-3 py-2 text-right" colspan={headers.length-1}>Total</td><td class="border px-3 py-2">{total}</td></tr>);
                                })()}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // SCENARIO B: LIST (Array of Strings) - Like "Selection Process", "Documents"
        if (type === 'list') {
            return (
                <div class="mb-8 border border-gray-300 rounded-sm overflow-hidden">
                    <div class="bg-[#004B8D] text-white text-center font-bold py-2 text-sm uppercase">{title}</div>
                    <div class="bg-gray-50 p-4">
                        <ul class="list-disc pl-5 space-y-2 text-sm text-gray-800 font-medium">
                            {data.map(item => <li set:html={formatText(item)}></li>)}
                        </ul>
                    </div>
                </div>
            );
        }

        // SCENARIO C: TEXT BLOCK (Simple String) - Like "Experience Note"
        if (type === 'text') {
            return (
                <div class="mb-8 border border-gray-300 rounded-sm overflow-hidden">
                    <div class="bg-gray-700 text-white text-center font-bold py-2 text-sm uppercase">{title}</div>
                    <div class="bg-gray-50 p-4 text-sm text-gray-800 leading-relaxed whitespace-pre-line" set:html={formatText(data)}></div>
                </div>
            );
        }

        return null;
    })}

    {/* 5. IMPORTANT LINKS (Standard) */}
    {post.links && (
      <div id="links" class="mb-8 border border-gray-400 rounded-sm overflow-hidden">
        <div class="bg-[#d91e18] text-white text-center font-bold py-2 text-lg uppercase">Important Links</div>
        <div class="bg-white">
            <table class="w-full text-sm md:text-base border-collapse">
                <tbody>
                    {post.links.map((link, i) => (
                        <tr class={`hover:bg-red-50 transition ${i !== post.links.length - 1 ? 'border-b border-gray-300' : ''}`}>
                            <td class="px-4 py-3 font-bold text-gray-700 border-r border-gray-300 w-2/3">{link.title}</td>
                            <td class="px-4 py-2 text-center">
                                <a href={link.url} target="_blank" class={`inline-block px-4 py-1.5 rounded-full text-xs font-bold uppercase shadow-sm ${getBtnStyle(link.title)}`}>Click Here ‚Üó</a>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
      </div>
    )}

    {/* 6. FAQS (Standard) */}
    {post.faqs && (
      <div class="mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Frequently Asked Questions</h3>
        <div class="border border-gray-300 rounded divide-y divide-gray-300">
          {post.faqs.map(f => (
            <details class="group bg-white">
              <summary class="font-semibold cursor-pointer p-4 flex justify-between items-center text-gray-800 hover:bg-gray-50">{f.question}<span class="text-blue-500 font-bold">‚ñº</span></summary>
              <div class="px-4 pb-4 pt-2 text-gray-600 text-sm border-t border-gray-100">{f.answer}</div>
            </details>
          ))}
        </div>
      </div>
    )}

    <div class="text-center text-[11px] text-gray-400 mt-8 mb-4">Disclaimer: Verify details from official notification.</div>

  </article>

  {/* SOCIAL SHARE */}
  <div class="flex justify-center gap-4 mb-10">
      <a href={waLink} target="_blank" class="bg-[#25D366] text-white px-5 py-2.5 rounded-full shadow-lg text-sm font-bold flex items-center gap-2">WhatsApp</a>
      <a href={tgLink} target="_blank" class="bg-[#229ED9] text-white px-5 py-2.5 rounded-full shadow-lg text-sm font-bold flex items-center gap-2">Telegram</a>
  </div>

</Layout>

---
import Layout from '../layouts/Layout.astro';
import AdSlot from '../components/AdSlot.astro';
import { allPosts } from '../data/index.js';

// --- üß† CATEGORIZED MASTER LISTS ---
const centralList = ["Central Govt", "Other States"];

const utList = [
  "Delhi", "Chandigarh", "Jammu & Kashmir", "Ladakh", 
  "Puducherry", "Andaman & Nicobar", "Lakshadweep", "Dadra & Nagar Haveli"
];

const stateList = [
  "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", 
  "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", 
  "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", 
  "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", 
  "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
];

const allLocations = [...centralList, ...utList, ...stateList];

// --- üß† SERVER SIDE LOGIC ---
const getJobsByState = (stateName) => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // 1. Filter Logic
  let jobs = allPosts.filter(post => {
    if (post.category !== 'Latest Jobs' && post.category !== 'Admission') return false;
    
    // Normalize State Strings
    let postState = (post.state || "Other States").toLowerCase();
    let targetState = stateName.toLowerCase();
    
    // Central Govt Handling
    if (targetState === "central govt" && (postState === "all india" || postState === "central govt")) return true;
    
    // Dadra Handling (Safe Check)
    if (targetState.includes("dadra") && postState.includes("dadra")) return true;

    return postState === targetState;
  });

  // 2. Active Check (Only Future Jobs)
  jobs = jobs.filter(post => {
     const lastDateObj = post.importantDates?.find(d => 
       d.label.toLowerCase().includes('last date') || d.label.toLowerCase().includes('closing date')
     );
     if (!lastDateObj) return true;

     const dateStr = lastDateObj.value.replace(/ \(.*\)/, '').trim();
     const parts = dateStr.split(/[/-]/);
     if (parts.length !== 3) return true;
     
     const jobDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
     return jobDate >= today;
  });

  return jobs;
};

// Colors for Buttons
const btnBaseClass = "text-center py-2 px-2 rounded border text-[11px] md:text-xs font-bold uppercase transition transform hover:scale-105 shadow-sm block decoration-0";
---

<Layout title="State Wise Govt Jobs 2025 - Find Jobs in UP, Bihar, Delhi, Rajasthan" description="Check State Wise Government Jobs 2025. Find active Sarkari Naukri in Uttar Pradesh, Bihar, Haryana, Rajasthan, Delhi and All India Central Govt Vacancies.">

  <div class="max-w-7xl mx-auto px-2 md:px-4 py-6 font-sans">
    
    <div class="flex flex-col lg:flex-row gap-6 items-start">

      {/* --- LEFT COLUMN: MAIN CONTENT --- */}
      <main class="flex-1 min-w-0 w-full">
        
        {/* 1. HEADER SECTION */}
        <div class="text-center mb-6 bg-white p-6 border border-gray-200 shadow-sm rounded-lg relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600"></div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 uppercase tracking-tight mb-2">
            State Wise <span class="text-[#1a56db]">Govt Jobs</span>
          </h1>
          <p class="text-xs md:text-sm text-gray-500 font-bold tracking-widest uppercase">
            Select your state below to find active recruitment
          </p>
        </div>

        <AdSlot type="horizontal" />

        {/* 2. STATE NAVIGATION PANEL (Categorized) */}
        <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm mb-8 space-y-6">
            
            {/* Show All Button */}
            <div class="text-center border-b border-gray-100 pb-4">
                <a href="#" onclick="filterState('all'); return false;" class={`${btnBaseClass} bg-gray-900 text-white border-gray-900 hover:bg-gray-700 w-full md:w-1/3 mx-auto flex items-center justify-center`}>
                    Show All India Jobs
                </a>
            </div>

            {/* Section A: Central & UTs */}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* Central Govt */}
                <div>
                    <h3 class="text-xs font-bold text-[#d32f2f] uppercase mb-2 flex items-center gap-1">
                        üèõÔ∏è Central & All India
                    </h3>
                    <div class="grid grid-cols-2 gap-2">
                        {centralList.map(state => (
                            <a href={`#${state.replace(/\s+/g, '-').toLowerCase()}`} 
                               class={`${btnBaseClass} bg-red-50 border-red-200 text-red-700 hover:bg-red-600 hover:text-white`}>
                                {state}
                            </a>
                        ))}
                    </div>
                </div>

                {/* Union Territories */}
                <div>
                    <h3 class="text-xs font-bold text-[#1976d2] uppercase mb-2 flex items-center gap-1">
                        üèôÔ∏è Union Territories (UTs)
                    </h3>
                    <div class="grid grid-cols-2 gap-2">
                        {utList.map(state => (
                            <a href={`#${state.replace(/\s+/g, '-').toLowerCase()}`} 
                               class={`${btnBaseClass} bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-600 hover:text-white`}>
                                {state}
                            </a>
                        ))}
                    </div>
                </div>
            </div>

            {/* Section B: States (A-Z) */}
            <div>
                <h3 class="text-xs font-bold text-[#388e3c] uppercase mb-2 flex items-center gap-1 border-t border-gray-100 pt-4">
                    üìç States (A-Z)
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    {stateList.map(state => (
                        <a href={`#${state.replace(/\s+/g, '-').toLowerCase()}`} 
                           class={`${btnBaseClass} bg-green-50 border-green-200 text-green-700 hover:bg-green-600 hover:text-white`}>
                            {state}
                        </a>
                    ))}
                </div>
            </div>

        </div>

        {/* 3. STATE WISE LISTINGS (Container) */}
        <div id="states-container" class="space-y-8 min-h-[300px]">
            {allLocations.map((state) => {
                const stateJobs = getJobsByState(state);
                const stateId = state.replace(/\s+/g, '-').toLowerCase();

                return (
                    <div id={stateId} class="state-section scroll-mt-24 transition-all duration-300">
                        
                        {/* State Header Strip */}
                        <div class="bg-gray-800 text-white px-4 py-2 rounded-t-lg flex items-center justify-between shadow-sm">
                            <h2 class="text-sm md:text-base font-bold uppercase tracking-wide flex items-center gap-2">
                                {state} Jobs
                            </h2>
                            <span class="text-xs bg-white text-gray-800 px-2 py-0.5 rounded-full font-bold">
                                {stateJobs.length}
                            </span>
                        </div>

                        {/* Table Container */}
                        <div class="bg-white border-x border-b border-gray-300 rounded-b-lg overflow-hidden shadow-sm">
                            
                            {/* Table Header */}
                            <div class="grid grid-cols-[90px_1fr] bg-[#f1f1f1] border-b border-gray-300 text-xs font-bold text-gray-600 uppercase">
                                <div class="p-2 text-center border-r border-gray-300">Last Date</div>
                                <div class="p-2 pl-4">Vacancy Name</div>
                            </div>

                            {/* Job Rows */}
                            {stateJobs.length > 0 ? (
                                stateJobs.map((post) => {
                                    let lastDateVal = post.importantDates?.find(d => d.label.toLowerCase().includes('last date'))?.value || "Check Notice";
                                    lastDateVal = lastDateVal.replace(/ \(.*\)/, '').trim();

                                    return (
                                        <div class="grid grid-cols-[90px_1fr] border-b border-gray-200 hover:bg-yellow-50 transition group last:border-0">
                                            {/* Date */}
                                            <div class="p-3 border-r border-gray-200 text-center flex items-center justify-center text-[11px] font-bold text-red-600 bg-gray-50 group-hover:bg-yellow-50">
                                                {lastDateVal}
                                            </div>
                                            {/* Title */}
                                            <div class="p-3 pl-4 flex items-center">
                                                <a href={`/${post.slug}`} class="text-[#1a56db] font-bold text-xs md:text-sm hover:underline leading-tight block">
                                                    {post.shortTitle || post.title}
                                                </a>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                /* Empty State Message */
                                <div class="text-center py-6">
                                    <p class="text-xs text-gray-400 italic">No active recruitment in {state} currently.</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            })}
        </div>

        <div class="mt-8">
            <AdSlot type="horizontal" />
        </div>

      </main>

      {/* --- RIGHT COLUMN: SIDEBAR --- */}
      <aside class="hidden lg:block w-[300px] flex-shrink-0">
        <div class="sticky top-4 space-y-6">
            
            {/* WhatsApp Widget */}
            <a href="https://whatsapp.com/channel/0029Vb7TcG06LwHoTXhZKn2D" target="_blank" class="block bg-white border-l-4 border-[#25D366] p-4 shadow-sm hover:shadow-md transition rounded">
                <div class="flex items-center gap-3">
                    <div class="bg-[#25D366] text-white p-2 rounded-full">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 font-bold uppercase">Join us on</div>
                        <div class="text-lg font-bold text-gray-800 leading-none">WhatsApp</div>
                    </div>
                </div>
            </a>

            {/* Telegram Widget */}
            <a href="https://t.me/toponlineform" target="_blank" class="block bg-white border-l-4 border-[#229ED9] p-4 shadow-sm hover:shadow-md transition rounded">
                <div class="flex items-center gap-3">
                    <div class="bg-[#229ED9] text-white p-2 rounded-full">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 11.944 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 font-bold uppercase">Join us on</div>
                        <div class="text-lg font-bold text-gray-800 leading-none">Telegram</div>
                    </div>
                </div>
            </a>

            <AdSlot type="square" />

        </div>
      </aside>

    </div>
  </div>

  {/* ‚ö° CLIENT SIDE FILTER LOGIC (Updated for Hash Support) */}
  <script is:inline>
    // 1. Function to show only selected state
    function filterState(targetId) {
        const allSections = document.querySelectorAll('.state-section');
        
        if (targetId === 'all' || !targetId) {
            // Show All
            allSections.forEach(sec => sec.classList.remove('hidden'));
        } else {
            // Hide All first
            allSections.forEach(sec => sec.classList.add('hidden'));
            
            // Show Targeted
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                // Scroll Logic is handled by browser hash default mostly, but we ensure visibility
            }
        }
    }

    // 2. Event Listener for URL Hash Change (Browser Back/Forward)
    window.addEventListener('hashchange', () => {
        const hash = window.location.hash.replace('#', '');
        filterState(hash || 'all');
    });

    // 3. Initial Load Check
    window.addEventListener('load', () => {
        const hash = window.location.hash.replace('#', '');
        filterState(hash || 'all');
    });
  </script>

</Layout>

---
import Layout from '../layouts/Layout.astro';
import { allPosts } from '../data/index.js';

// --- üß† SERVER SIDE LOGIC: FILTER ACTIVE JOBS ---

const getActiveJobs = () => {
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate comparison

  // 1. Filter Logic
  const active = allPosts.filter(post => {
    // Find the "Last Date" field in importantDates
    const lastDateObj = post.importantDates?.find(d => 
      d.label.toLowerCase().includes('last date') || 
      d.label.toLowerCase().includes('closing date')
    );

    // If no Last Date is mentioned, we assume it's Active (Safety Fallback)
    if (!lastDateObj) return true;

    // Parse Date (DD/MM/YYYY)
    const dateStr = lastDateObj.value.replace(/ \(.*\)/, '').trim(); // Remove (5:00 PM) etc
    const parts = dateStr.split(/[/-]/); // Handle / or -
    
    if (parts.length !== 3) return true; // If format is weird, keep it active

    // Create Date Object (YYYY, MM-1, DD)
    const jobDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    
    // Check if Job Date is in the future or today
    return jobDate >= today;
  });

  // 2. Sort Logic (Closing Soonest First is best for Active Jobs tracker)
  active.sort((a, b) => {
    const getDate = (p) => {
       const dObj = p.importantDates?.find(d => d.label.toLowerCase().includes('last date'));
       if(!dObj) return 9999999999999; // Far future
       const pts = dObj.value.replace(/ \(.*\)/, '').trim().split(/[/-]/);
       return new Date(`${pts[2]}-${pts[1]}-${pts[0]}`).getTime();
    };
    return getDate(a) - getDate(b);
  });

  return active;
};

const activePosts = getActiveJobs();
---

<Layout title="Active Jobs Tracker - Top Online Form" description="Track all live government job applications and deadlines.">

  <div class="bg-gray-50 min-h-screen p-3 md:p-8 font-sans">
    
    {/* --- HEADER SECTION --- */}
    <div class="text-center mb-6">
      <h1 class="text-2xl md:text-4xl font-extrabold text-[#1a56db] uppercase tracking-tight mb-2">
        Current Active Applications
      </h1>
      <p class="text-xs md:text-sm text-gray-500 font-bold tracking-widest uppercase">
        Live Central & State Govt Recruitment Deadline Tracker
      </p>
    </div>

    {/* --- MAIN TABLE CONTAINER --- */}
    <div class="max-w-5xl mx-auto bg-white border border-gray-300 shadow-sm rounded-t-lg overflow-hidden">
      
      {/* 1. BLUE HEADER BAR */}
      <div class="bg-[#004B8D] text-white text-center font-bold py-3 text-sm md:text-base uppercase tracking-wide">
        Active Govt Jobs & Admissions (Live)
      </div>

      {/* 2. SEARCH BOX ROW */}
      <div class="p-2 border-b border-gray-300 bg-gray-50">
        <input 
          type="text" 
          id="jobSearchInput" 
          placeholder="Search within active jobs..." 
          class="w-full p-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-blue-500 shadow-inner"
        />
      </div>

      {/* 3. TABLE HEADERS */}
      <div class="grid grid-cols-[90px_1fr] md:grid-cols-[120px_1fr] bg-[#f1f1f1] border-b border-gray-300 text-xs md:text-sm font-bold text-gray-700 uppercase">
        <div class="p-3 border-r border-gray-300 text-center flex items-center justify-center">Last Date</div>
        <div class="p-3">Post Name / Details</div>
      </div>

      {/* 4. JOB LIST (Dynamic Rows) */}
      <div id="jobListContainer">
        {activePosts.length > 0 ? (
          activePosts.map((post) => {
            // Extract Last Date for Display
            const lastDateVal = post.importantDates?.find(d => d.label.toLowerCase().includes('last date'))?.value || "Check Notification";
            
            return (
              <div class="job-row grid grid-cols-[90px_1fr] md:grid-cols-[120px_1fr] border-b border-gray-200 hover:bg-yellow-50 transition group">
                
                {/* Date Column */}
                <div class="p-3 border-r border-gray-200 text-center flex flex-col justify-center text-[10px] md:text-xs font-bold text-red-600 bg-gray-50 group-hover:bg-yellow-50">
                  <span>{lastDateVal.split(' ')[0]}</span> {/* Show only date part */}
                </div>

                {/* Title Column */}
                <div class="p-3 flex items-center justify-between">
                  <div>
                    <a href={`/job/${post.slug}`} class="text-[#1a56db] font-bold text-xs md:text-sm hover:underline leading-tight block">
                      {post.shortTitle || post.title}
                    </a>
                    {post.totalPost && <span class="text-[10px] text-gray-500 font-medium">Total Posts: {post.totalPost}</span>}
                  </div>
                  
                  {/* Mobile Arrow / Desktop Button */}
                  <a href={`/job/${post.slug}`} class="hidden md:inline-block ml-2 text-[10px] font-bold text-white bg-green-600 px-2 py-1 rounded hover:bg-green-700">
                    Apply
                  </a>
                </div>

              </div>
            );
          })
        ) : (
          <div class="text-center py-10 text-gray-500 text-sm">
            No Active Jobs Found currently.
          </div>
        )}
      </div>

      {/* No Results Message (Hidden by default) */}
      <div id="noResultsMsg" class="hidden text-center py-8 text-gray-400 text-xs uppercase tracking-widest">
        No Matching Active Jobs Found.
      </div>

    </div>

    {/* --- FOOTER INFO SECTION --- */}
    <div class="max-w-5xl mx-auto mt-8 bg-white border border-gray-200 p-6 rounded shadow-sm">
      <h3 class="text-gray-800 font-bold uppercase text-sm mb-4 border-b border-gray-200 pb-2">
        Why Track Active Jobs?
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-xs md:text-sm text-gray-600 leading-relaxed">
        <p>
          Missing a deadline can mean waiting for another year. Our <strong>Active Jobs Tracker</strong> filters through hundreds of notifications to show you exactly what is still open for application.
        </p>
        <p>
          We monitor <strong>SSC, UPSC, Railway, Bank, and State Selection Boards</strong> daily to ensure you never miss an opportunity to apply for your dream government career.
        </p>
      </div>
    </div>

  </div>

  {/* üîç CLIENT SIDE SEARCH SCRIPT */}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('jobSearchInput');
      const jobRows = document.querySelectorAll('.job-row');
      const noResultsMsg = document.getElementById('noResultsMsg');

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        let hasVisible = false;

        jobRows.forEach(row => {
          const text = row.innerText.toLowerCase();
          if (text.includes(query)) {
            row.style.display = 'grid'; // Grid layout wapas lao
            hasVisible = true;
          } else {
            row.style.display = 'none';
          }
        });

        // Show/Hide "No Results" message
        if (hasVisible) {
          noResultsMsg.classList.add('hidden');
        } else {
          noResultsMsg.classList.remove('hidden');
        }
      });
    });
  </script>

</Layout>

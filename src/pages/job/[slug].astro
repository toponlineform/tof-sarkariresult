---
import Layout from '../../layouts/Layout.astro';
// ‚úÖ Smart Import (Master File se data lo)
import { allPosts } from '../../data/index.js';

export async function getStaticPaths() {
  const { allPosts } = await import('../../data/index.js');
  return allPosts.map((post) => {
    // Related Logic: Same Category ki jobs dikhao
    const relatedPosts = allPosts.filter(p => p.category === post.category && p.slug !== post.slug).slice(0, 6);
    return {
      params: { slug: post.slug },
      props: { post, relatedPosts },
    };
  });
}

const { post, relatedPosts } = Astro.props;

// --- üõ†Ô∏è 1. SMART HELPERS (Magic Functions) ---

// Text Formatter: "**Text**" ko <b>Text</b> me badalta hai
const formatText = (text) => {
  if (!text) return "";
  return text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>');
};

// Link Color Decider: Link ke title se color choose karta hai
const getLinkColor = (title) => {
  const t = title.toLowerCase();
  if (t.includes('apply') || t.includes('register') || t.includes('login')) return 'bg-blue-600 hover:bg-blue-700 text-white';
  if (t.includes('download') || t.includes('notification') || t.includes('pdf')) return 'bg-red-600 hover:bg-red-700 text-white';
  if (t.includes('official') || t.includes('website')) return 'bg-gray-700 hover:bg-gray-800 text-white';
  if (t.includes('syllabus') || t.includes('pattern')) return 'bg-purple-600 hover:bg-purple-700 text-white';
  return 'bg-green-600 hover:bg-green-700 text-white'; // Default
};

// Share Text
const currentUrl = `https://toponlineform.com/job/${post.slug}`;
const shareText = `üî• New Update: ${post.shortTitle || post.title} \nCheck Details & Apply Now: ${currentUrl}`;
---

<Layout title={post.title} description={post.shortInfo} keywords={post.tags}>
  
  <article class="bg-white p-3 md:p-8 rounded-xl shadow-sm border border-gray-200 font-sans">
    
    {/* üü¢ HEADER SECTION */}
    <header class="text-center mb-8">
      <h1 class="text-2xl md:text-4xl font-extrabold text-gray-900 mb-3 leading-tight">{post.title}</h1>
      <div class="flex flex-wrap justify-center gap-3 text-sm text-gray-500 font-medium">
        <span class="bg-gray-100 px-2 py-1 rounded">üìÖ Posted: {post.postDate}</span>
        <span class="bg-gray-100 px-2 py-1 rounded">üîÑ Updated: {new Date().toLocaleDateString()}</span>
        {post.totalPost && <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">üì¶ Total Posts: {post.totalPost}</span>}
      </div>
    </header>

    {/* üü° SHORT INFO (Brief) */}
    {post.shortInfo && (
      <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-8 rounded-r-lg shadow-sm">
        <h2 class="text-lg font-bold text-amber-800 mb-2 flex items-center gap-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"></path></svg>
          Short Information
        </h2>
        <p class="text-gray-700 text-sm md:text-base leading-relaxed" set:html={formatText(post.shortInfo)}></p>
      </div>
    )}

    {/* üî¥ DATES & FEES GRID (Super Flexible) */}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      
      {/* Dates Box */}
      {post.importantDates && (
        <div class="border border-red-200 rounded-xl overflow-hidden shadow-sm">
          <div class="bg-red-50 px-4 py-3 border-b border-red-200 flex items-center gap-2">
            <span class="text-xl">üìÖ</span>
            <h3 class="font-bold text-red-800 text-lg">Important Dates</h3>
          </div>
          <div class="p-4 bg-white">
            <ul class="space-y-3 text-sm">
              {post.importantDates.map((date) => (
                <li class="flex justify-between items-start border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                  <span class="text-gray-600 font-medium">{date.label}</span>
                  <span class="font-bold text-gray-900 text-right ml-4">{date.value}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      )}

      {/* Fees Box */}
      {post.applicationFee && (
        <div class="border border-blue-200 rounded-xl overflow-hidden shadow-sm">
          <div class="bg-blue-50 px-4 py-3 border-b border-blue-200 flex items-center gap-2">
            <span class="text-xl">‚Çπ</span>
            <h3 class="font-bold text-blue-800 text-lg">Application Fee</h3>
          </div>
          <div class="p-4 bg-white">
            <ul class="space-y-3 text-sm">
              {post.applicationFee.map((fee) => (
                <li class="flex justify-between items-start border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                  <span class="text-gray-600 font-medium">{fee.category}</span>
                  <span class="font-bold text-gray-900 text-right ml-4">{fee.amount}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      )}
    </div>

    {/* üîµ AGE LIMIT & ELIGIBILITY (Detailed) */}
    <div class="mb-8">
      <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-gray-200 pb-2">Vacancy & Eligibility Details</h3>
      
      {/* Age Limit Text */}
      {post.ageLimit && (
        <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
          <p class="text-gray-700"><strong>üõ°Ô∏è Age Limit:</strong> {post.ageLimit}</p>
          {post.ageRelaxation && (
             <ul class="list-disc pl-5 mt-2 text-sm text-gray-600">
               {post.ageRelaxation.map(rule => <li>{rule}</li>)}
             </ul>
          )}
        </div>
      )}

      {/* Basic Vacancy Table */}
      {post.vacancyDetails && (
        <div class="overflow-x-auto rounded-lg border border-gray-300 shadow-sm">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-800 text-white uppercase">
              <tr>
                <th class="px-4 py-3 whitespace-nowrap">Post Name</th>
                <th class="px-4 py-3 text-center whitespace-nowrap">Total</th>
                <th class="px-4 py-3">Eligibility / Qualification</th>
              </tr>
            </thead>
            <tbody>
              {post.vacancyDetails.map((v, index) => (
                <tr class={`border-b border-gray-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-yellow-50 transition`}>
                  <td class="px-4 py-3 font-semibold text-blue-900">{v.postName}</td>
                  <td class="px-4 py-3 text-center font-bold">{v.totalPost || v.total}</td>
                  <td class="px-4 py-3 text-gray-700 leading-relaxed" set:html={formatText(v.eligibility)}></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>

    {/* üî• SMART DYNAMIC TABLE (For State/Zone/Category Wise Data) */}
    {/* Ye section automatically table headings banayega data k hisaab se */}
    {post.stateWiseVacancy && post.stateWiseVacancy.length > 0 && (
      <div class="mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
          <span class="bg-blue-600 w-1 h-6 rounded"></span>
          {post.vacancyTableTitle || "Detailed Vacancy Breakdown"}
        </h3>
        <div class="overflow-x-auto rounded-lg border border-gray-300 shadow-sm scrollbar-thin">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-700 text-white uppercase text-xs">
              <tr>
                {Object.keys(post.stateWiseVacancy[0]).map(key => (
                  <th class="px-3 py-3 border-r border-gray-600 last:border-0 whitespace-nowrap">{key}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {post.stateWiseVacancy.map((row, i) => (
                <tr class={`border-b border-gray-200 ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                  {Object.values(row).map(val => (
                    <td class="px-3 py-2 border-r border-gray-200 last:border-0 font-medium text-gray-700 whitespace-nowrap">{val}</td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {post.stateTableNote && <p class="text-xs text-gray-500 mt-1 italic">* Scroll right to view full table if on mobile.</p>}
      </div>
    )}

    {/* üìö EXAM PATTERN & SYLLABUS (Multi-Stage Handler) */}
    {post.examPattern && (
      <div class="mb-8 bg-indigo-50 p-4 md:p-6 rounded-xl border border-indigo-100">
        <h3 class="text-xl font-bold text-indigo-900 mb-4 border-b border-indigo-200 pb-2">Exam Pattern & Syllabus</h3>
        
        {/* Pattern Details (Points) */}
        {post.examPattern.details && (
          <ul class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-6">
            {post.examPattern.details.map(d => (
              <li class="flex items-start gap-2 text-sm text-gray-700">
                <span class="text-indigo-500 mt-1">‚óè</span>
                <span set:html={formatText(d)}></span>
              </li>
            ))}
          </ul>
        )}

        {/* Handling Simple Table */}
        {post.examPattern.table && (
          <div class="overflow-x-auto bg-white rounded shadow-sm mb-4">
            <table class="w-full text-sm border">
              <thead class="bg-indigo-100 text-indigo-900">
                <tr>
                  <th class="p-2 border">Subject</th>
                  <th class="p-2 border text-center">Questions</th>
                  <th class="p-2 border text-center">Marks</th>
                </tr>
              </thead>
              <tbody>
                {post.examPattern.table.map(row => (
                  <tr class="border-b">
                    <td class="p-2 border font-medium">{row.subject}</td>
                    <td class="p-2 border text-center">{row.questions}</td>
                    <td class="p-2 border text-center">{row.marks}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {/* Handling Multiple Stages (e.g. Tier 1, Tier 2, PET) */}
        {(post.examPattern.stages || post.examPattern.tier1 || post.examPattern.pet) && (
          <div class="space-y-6">
            {/* Logic to merge all stage types into one loop */}
            {[
               ...(post.examPattern.stages || []),
               post.examPattern.tier1 ? { title: "Tier-I / CBT-1 Pattern", data: post.examPattern.tier1 } : null,
               post.examPattern.tier2 ? { title: "Tier-II / CBT-2 Pattern", data: post.examPattern.tier2 } : null,
               post.examPattern.pet ? { title: "Physical Efficiency Test (PET)", tableType: 'pet', data: post.examPattern.pet } : null
            ].filter(Boolean).map(stage => (
              <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <h4 class="font-bold text-gray-800 mb-3 uppercase text-xs tracking-wider bg-gray-100 p-2 rounded inline-block">{stage.title}</h4>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm border-collapse">
                    {/* PET Table Header is different */}
                    {stage.tableType === 'pet' ? (
                       <thead class="bg-gray-50 text-gray-700"><tr><th class="p-2 border text-left">Activity</th><th class="p-2 border">Male</th><th class="p-2 border">Female</th></tr></thead>
                    ) : (
                       <thead class="bg-gray-50 text-gray-700"><tr><th class="p-2 border text-left">Subject / Section</th><th class="p-2 border text-center">Qs</th><th class="p-2 border text-center">Marks</th></tr></thead>
                    )}
                    
                    <tbody>
                      {stage.data.map(r => (
                        <tr class="border-b last:border-0">
                          {stage.tableType === 'pet' ? (
                            <>
                              <td class="p-2 border font-medium text-gray-800">{r.activity}</td>
                              <td class="p-2 border text-center">{r.male}</td>
                              <td class="p-2 border text-center">{r.female}</td>
                            </>
                          ) : (
                            <>
                              <td class="p-2 border font-medium text-gray-800">{r.subject}</td>
                              <td class="p-2 border text-center">{r.questions}</td>
                              <td class="p-2 border text-center">{r.marks}</td>
                            </>
                          )}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    )}

    {/* ‚ûï EXTRA SECTIONS (Any random data: Physical, Venues, Documents) */}
    {post.extraSections && post.extraSections.map((section, idx) => (
      <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-lg font-bold text-gray-900 mb-3">{section.title}</h3>
        
        {/* If Text Block */}
        {section.text && <p class="text-sm text-gray-700 whitespace-pre-line mb-3" set:html={formatText(section.text)}></p>}
        
        {/* If List */}
        {section.list && (
          <ul class="list-disc pl-5 text-sm text-gray-700 space-y-2">
            {section.list.map(l => <li set:html={formatText(l)}></li>)} 
          </ul>
        )}

        {/* If Table */}
        {section.tableData && (
          <div class="overflow-x-auto mt-2 bg-white rounded border border-gray-200">
            <table class="w-full text-sm">
              <thead class="bg-gray-100 font-bold text-gray-700">
                <tr>
                  {Object.keys(section.tableData[0]).map(k => <th class="p-2 border capitalize">{k}</th>)}
                </tr>
              </thead>
              <tbody>
                {section.tableData.map(row => (
                  <tr class="border-b last:border-0">
                    {Object.values(row).map(v => <td class="p-2 border text-center">{v}</td>)}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    ))}

    {/* üîó IMPORTANT LINKS (Super Smart Grid) */}
    {post.links && (
      <div class="mb-8" id="important-links">
        <h2 class="text-2xl font-bold text-gray-900 mb-5 flex items-center gap-2">
          <span class="text-red-600">üîó</span> Important Links
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {post.links.map(link => (
            <a href={link.url} target="_blank" class={`flex items-center justify-between p-4 rounded-lg shadow-sm transition transform hover:-translate-y-1 hover:shadow-md ${getLinkColor(link.title)}`}>
              <span class="font-bold tracking-wide">{link.title}</span>
              <span class="bg-white/20 p-1 rounded-full">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
              </span>
            </a>
          ))}
        </div>
      </div>
    )}

    {/* üìù HOW TO APPLY (Step List) */}
    {post.howToApply && (
      <div class="mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-3">How to Apply</h3>
        <div class="bg-gray-50 p-5 rounded-lg border border-gray-200">
          <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-700">
            {post.howToApply.map(step => <li set:html={formatText(step)}></li>)}
          </ol>
        </div>
      </div>
    )}

    {/* ‚ùì FAQs (Schema Ready) */}
    {post.faqs && (
      <div class="mt-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Frequently Asked Questions</h3>
        <div class="space-y-3">
          {post.faqs.map(faq => (
            <details class="bg-white border border-gray-200 rounded-lg group">
              <summary class="font-semibold cursor-pointer p-4 list-none flex justify-between items-center text-gray-800 hover:bg-gray-50 rounded-lg">
                {faq.question}
                <span class="text-gray-400 group-open:rotate-180 transition transform duration-200">‚ñº</span>
              </summary>
              <div class="px-4 pb-4 pt-0 text-gray-600 text-sm leading-relaxed border-t border-gray-100 mt-2">
                {faq.answer}
              </div>
            </details>
          ))}
        </div>
      </div>
    )}

    {/* üì≤ SOCIAL SHARE (Floating/Sticky feel on Desktop) */}
    <div class="mt-10 pt-6 border-t border-gray-200 text-center">
        <p class="text-gray-500 font-bold mb-4 text-sm uppercase tracking-wide">Share this Update</p>
        <div class="flex justify-center gap-4">
            <a href={`https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`} target="_blank" class="bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center gap-2 transition">
              <span>WhatsApp</span>
            </a>
            <a href={`https://t.me/share/url?url=${currentUrl}&text=${encodeURIComponent(shareText)}`} target="_blank" class="bg-[#0088cc] hover:bg-[#0077b5] text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center gap-2 transition">
              <span>Telegram</span>
            </a>
        </div>
    </div>

  </article>

  {/* ü§ñ JSON-LD SCHEMA (Google SEO) */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "JobPosting",
    "title": post.title,
    "description": post.shortInfo,
    "datePosted": post.postDate ? new Date(post.postDate.split('/').reverse().join('-')).toISOString() : new Date().toISOString(),
    "validThrough": post.importantDates?.find(d => d.label.includes("Last Date"))?.value || "2026-12-31",
    "hiringOrganization": { "@type": "Organization", "name": "Top Online Form" },
    "jobLocation": { "@type": "Place", "address": { "@type": "PostalAddress", "addressCountry": "IN", "addressRegion": post.state || "India" } }
  })} />

</Layout>
